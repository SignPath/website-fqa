<!-- last_modified_at:  --><!DOCTYPE html>
<html lang="en" data-appurl='https://fqa.test.signpath.io'>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="canonical" href='https://signpath.github.io/website-staging//documentation/crypto-providers' />
  <!-- Begin Jekyll SEO tag v2.6.1 -->
  <link rel='preload' as='style' href='/assets/css/line-awesome.min.css' onload="this.rel='stylesheet'">
  <title>Documentation - Crypto Providers | SignPath</title>
  <meta property="og:title" content="Documentation - Crypto Providers | SignPath" />
  <meta property="og:locale" content="en_US" />
  <meta property="og:description" content="SignPath Crypto Providers (CSP, KSP, Cryptoki)" />
  <meta property="og:url" content="https://signpath.github.io/website-staging//documentation/crypto-providers" />
  <meta property="og:site_name" content="SignPath - Code Signing Simple and Secure" />
  <meta name="description" content="SignPath Crypto Providers (CSP, KSP, Cryptoki)"/>
  <!-- End Jekyll SEO tag -->
  <link rel='stylesheet' href='/assets/css/hint.min.css'>
  <link rel="stylesheet" href="/assets/css/index.css?cache=2023-11-17">
  <link rel="alternate" type="application/atom+xml" title="SignPath.io Blog" href="/feed.xml">
  <script src='/assets/index.js?cache=2023-11-17'></script>
  <script src='/assets/js/main-bundle.js?cache=2023-11-17'></script><link rel="icon" href="/assets/favicon-50x50.png" sizes="32x32">
  <link rel="icon" href="/assets/favicon.png" sizes="192x192">
  <link rel="apple-touch-icon-precomposed" href="/assets/favicon.png">
  <meta name="msapplication-TileImage" content="/assets/favicon.png">
</head>
<body>
  <header>
    <div>
      <a href='/'><img src='/assets/signpath-logo-white.svg' width="181" height="36" alt='SignPath'></a>
      <nav>
        <ul><li>
              <a href='/product'> Product </a>
              <ul><li> <a href='/product/features'> Features </a> </li><li> <a href='/product/editions'> Editions </a> </li><li class='separator' /><li> <a href='/product/devops'> For DevOps teams </a> </li><li> <a href='/product/infosec'> For InfoSec teams </a> </li><li> <a href='/product/open-source'> For Open Source projects </a> </li><li class='separator' /><li> <a href='/product/office-macros'> Office macro signing </a> </li><li> <a href='/product/pkic-best-practices'> PKI Consortium best practices </a> </li></ul>
            </li><li>
              <a href='/code-signing'> Code Signing </a>
              <ul><li> <a href='/code-signing/introduction'> Introduction </a> </li><li> <a href='/code-signing/theory'> Theory </a> </li><li> <a href='/code-signing/windows-platform'> Windows Platform </a> </li><li> <a href='/code-signing/test-certificates'> Managing Test Certificates </a> </li><li> <a href='/code-signing/private-keys'> Storage of Private Keys </a> </li><li> <a href='/code-signing/media-coverage'> Media Coverage </a> </li></ul>
            </li><li>
              <a href='/documentation'> Documentation </a>
              <ul><li> <a href='/documentation/getting-started'> Getting Started </a> </li><li> <a href='/documentation/managing-certificates'> Managing Certificates </a> </li><li> <a href='/documentation/users'> Managing Users </a> </li><li> <a href='/documentation/projects'> Setting up Projects </a> </li><li> <a href='/documentation/signing-code'> Signing Code </a> </li><li> <a href='/documentation/signing-containers'> Signing Container Images </a> </li><li class='separator' /><li> <a href='/documentation/artifact-configuration'> Artifact Configuration </a> </li><li> <a href='/documentation/build-system-integration'> Build System Integration </a> </li><li> <a href='/documentation/trusted-build-systems'> Trusted Build Systems </a> </li><li> <a href='/documentation/origin-verification'> Origin Verification </a> </li><li class='separator' /><li> <a href='/documentation/powershell'> PowerShell cmdlets </a> </li><li> <a href='/documentation/crypto-providers'> Crypto Providers </a> </li><li class='separator' /><li> <a href='/documentation/changelog'> Product updates </a> </li></ul>
            </li><li>
              <a href='/about-us'> About us </a>
              <ul><li> <a href='/company'> Company </a> </li><li> <a href='/blog'> Blog </a> </li><li> <a href='/jobs'> Jobs </a> </li><li> <a href='/contact'> Contact </a> </li></ul>
            </li><li class='login'><a class='btn btn-flat' href='https://fqa.test.signpath.io/Web/Home/Login'>Login</a>
          <li class='login'><a href='https://fqa.test.signpath.io/Web/Subscription/StartFreeTrial' class='btn btn-primary trial'>Start free trial</a></li>
          </li>
        </ul>
        <a id='main-menu-toggle' href='#' onclick='document.querySelector("header > div > nav > ul").classList.toggle("open")'>
          <div></div>
          <div></div>
          <div></div>
        </a>
      </nav>
    </div>
  </header>
  <main><section class="bg-blue font-white top-section">
	<div>
		<h1><span class='no-break'>Documentation &nbsp;‚ùØ&nbsp; </span> Crypto Providers</h1>
	</div>
</section>
<section class="resources-section">
	<div><aside>
				<ul><li class=''>
							<a href='/documentation/getting-started#'>Getting Started</a></li><li class=''>
							<a href='/documentation/managing-certificates#'>Managing Certificates</a></li><li class=''>
							<a href='/documentation/users#'>Managing Users</a></li><li class=''>
							<a href='/documentation/projects#'>Setting up Projects</a></li><li class=''>
							<a href='/documentation/signing-code#'>Signing Code</a></li><li class=''>
							<a href='/documentation/signing-containers#'>Signing Container Images</a></li><li class='separator' /><li class=''>
							<a href='/documentation/artifact-configuration#'>Artifact Configuration</a></li><li class=''>
							<a href='/documentation/build-system-integration#'>Build System Integration</a></li><li class=''>
							<a href='/documentation/trusted-build-systems#'>Trusted Build Systems</a></li><li class=''>
							<a href='/documentation/origin-verification#'>Origin Verification</a></li><li class='separator' /><li class=''>
							<a href='/documentation/powershell#'>PowerShell cmdlets</a></li><li class='active'>
							<a href='/documentation/crypto-providers#'>Crypto Providers</a><div class="no-mobile" ><ul>
  <li><a href="#overview">Overview</a></li>
  <li><a href="#installation">Installation</a></li>
  <li><a href="#crypto-provider-configuration">Crypto Provider configuration</a></li>
  <li><a href="#signpath-project-configuration">SignPath Project configuration</a></li>
  <li><a href="#windows-ksp-csp-signing-tools">Signing tools based on Windows KSP or CSP Crypto Provider</a></li>
  <li><a href="#cryptoki-signing-tools">Signing tools based on Cryptoki/PKCS #11 (Windows and Linux)</a></li>
  <li><a href="#direct-usage-of-the-signpath-rest-api">Direct usage of the SignPath REST API</a></li>
  <li><a href="#retrieve-signing-policy-details">Retrieve Signing Policy details</a></li>
</ul>
</div></li><li class='separator' /><li class=''>
							<a href='/documentation/changelog#'>Product updates</a></li></ul>
			</aside><article><ul class="article-toc">
  <li><a href="#overview">Overview</a>
    <ul>
      <li><a href="#crypto-providers">Crypto Providers</a></li>
      <li><a href="#linux-docker-samples">Linux Docker container samples</a></li>
    </ul>
  </li>
  <li><a href="#installation">Installation</a>
    <ul>
      <li><a href="#csp-ksp-installation">CSP/KSP installation (Windows)</a></li>
      <li><a href="#update-to-a-new-version">Update to a new version</a></li>
      <li><a href="#uninstallation">Uninstallation</a></li>
      <li><a href="#cryptoki">Cryptoki</a></li>
    </ul>
  </li>
  <li><a href="#crypto-provider-configuration">Crypto Provider configuration</a>
    <ul>
      <li><a href="#crypto-provider-config-values">Setting configuration values</a></li>
      <li><a href="#api-token-options">Options for providing the API token</a></li>
      <li><a href="#http-proxy-config">HTTP Proxy configuration</a></li>
    </ul>
  </li>
  <li><a href="#signpath-project-configuration">SignPath Project configuration</a></li>
  <li><a href="#windows-ksp-csp-signing-tools">Signing tools based on Windows KSP or CSP Crypto Provider</a>
    <ul>
      <li><a href="#general-instructions">General instructions</a></li>
      <li><a href="#error-return-values-for-ksp-and-csp-functions">Error return values for KSP and CSP functions</a></li>
      <li><a href="#signtool">SignTool.exe</a></li>
    </ul>
  </li>
  <li><a href="#cryptoki-signing-tools">Signing tools based on Cryptoki/PKCS #11 (Windows and Linux)</a>
    <ul>
      <li><a href="#general-instructions-1">General instructions</a></li>
      <li><a href="#openssl">OpenSSL</a></li>
      <li><a href="#prerequisites">Prerequisites</a></li>
      <li><a href="#osslsigncode">osslsigncode</a></li>
      <li><a href="#opensc-pkcs11-tool-linux">OpenSC pkcs11-tool (Linux)</a></li>
      <li><a href="#jarsigner">Java jarsigner</a></li>
      <li><a href="#gpg-signing">GPG Signing with GnuPG (Linux)</a></li>
      <li><a href="#rpm-signing-linux">RPM Signing (Linux)</a></li>
      <li><a href="#deb-signing-via-dpkg-sig-linux">DEB Signing via dpkg-sig (Linux)</a></li>
      <li><a href="#maven-artifact-signing-linux">Maven Artifact Signing (Linux)</a></li>
    </ul>
  </li>
  <li><a href="#direct-usage-of-the-signpath-rest-api">Direct usage of the SignPath REST API</a>
    <ul>
      <li><a href="#signing-request">Signing Request</a></li>
    </ul>
  </li>
  <li><a href="#retrieve-signing-policy-details">Retrieve Signing Policy details</a></li>
</ul>
<p class="badge icon-signpath">Available for Enterprise subscriptions</p>

<h2 id="overview">Overview</h2>

<p>The SignPath Crypto Providers allow signing tools such as <em>SignTool.exe</em>, <em>OpenSSL</em> or <em>jarsigner</em> to sign files locally using keys or certificates stored and managed by SignPath.</p>

<p>Crypto Providers are generally used to provide a device-independent API for using secure key storage devices such as USB key tokens or Hardware Security Modules (HSMs). You may think of them as device drivers for crypto hardware. Most software tools used for code signing support one Crypto Provider technology, such as Microsoft KSP/CSP or PKCS #11 Cryptoki.</p>

<p>The SignPath Crypto Providers do not access the crypto hardware directly. Instead, they implement these interfaces to provide access to SignPath <em>Projects</em> and <em>Signing Policies</em>. During the entire operation, the private key will remain on the HSM.</p>

<div class="panel info">
  <div class="panel-header">Version info</div>

  <p>This documentation contains information about the latest version of the CryptoProviders. See the <a href="/documentation/changelog?component=crypto_providers">changelog</a> for updates.</p>
</div>

<h3 id="crypto-providers">Crypto Providers</h3>

<p>The following Crypto Providers are available for SignPath:</p>
<table>
    <thead>
        <tr><th>

Crypto Provider 
</th><th>

Technology 
</th><th>

Supported platforms 
</th><th>

Description 
</th></tr>
    </thead>
    <tbody><tr><td>

        <p><strong>Cryptoki</strong> (Cryptographic Token Interface)</p>

      </td><td>

        <p><a href="https://docs.oasis-open.org/pkcs11/pkcs11-base/v2.40/os/pkcs11-base-v2.40-os.html">PKCS#11</a> version 2.40</p>

      </td><td>

        <p>Windows, Linux</p>
      </td><td>

      </td></tr><tr><td>

        <p><strong>KSP</strong> (Key Storage Provider)</p>

      </td><td>

        <p><a href="https://docs.microsoft.com/en-us/windows/win32/seccng/key-storage-and-retrieval">CNG</a> (Cryptographic API: Next Generation)</p>

      </td><td>

        <p>Windows</p>
      </td><td>

      </td></tr><tr><td>

        <p><strong>CSP</strong> (Cryptographic Service Provider)</p>

      </td><td>

        <p><a href="https://docs.microsoft.com/en-us/windows/win32/seccrypto/cryptographic-service-providers">CAPI</a> (CryptoAPI)</p>

      </td><td>

        <p>Windows</p>
      </td><td>

        <p>This API is deprecated, most tools now use KSP/CNG</p>
      </td></tr></tbody>
</table>
<h4 id="supported-linux-distributions">Supported Linux distributions</h4>
<table>
    <thead>
        <tr><th>

Distribution 
</th><th>

Version 
</th><th>

Comment 
</th></tr>
    </thead>
    <tbody><tr><td>

        <p>Debian</p>
      </td><td>

        <p>11</p>
      </td><td>

      </td></tr><tr><td>

        <p>Ubuntu</p>
      </td><td>

        <p>20.04</p>
      </td><td>

        <p>Except <a href="#osslsigncode">osslsigncode</a></p>
      </td></tr><tr><td>

        <p>RedHat</p>
      </td><td>

        <p>8 (latest minor)</p>
      </td><td>

      </td></tr><tr><td>

        <p>RedHat</p>
      </td><td>

        <p>9 (latest minor)</p>
      </td><td>

      </td></tr></tbody>
</table>
<div class="panel warning">
  <div class="panel-header">OpenSSL 3.0.0 - 3.0.8 incompatibility</div>

  <p>Distributions with an OpenSSL version between 3.0.0 and 3.0.8 (including) don‚Äôt support the the <a href="#openssl">OpenSSL</a> and <a href="#osslsigncode">osslsigncode</a> scenarios.
The reason is an <a href="https://github.com/openssl/openssl/issues/20161">OpenSSL bug</a> which has been fixed in OpenSSL 3.0.9.
The issue expresses in <em>‚Äúhttp_exception occurred (error code= generic:168296454): Error in SSL handshake‚Äù</em> errors.</p>

  <p>The workaround is to either replace the system‚Äôs OpenSSL version with &gt;= 3.0.9 or to use an isolated OpenSSL installation.</p>
</div>

<h3 id="linux-docker-samples">Linux Docker container samples</h3>

<p>For the supported Linux distributions we provide Docker container based example scripts to demonstrate the different signing tool scenarios, their configuration and the required dependencies.</p>

<p>See the <code class="language-plaintext highlighter-rouge">samples</code> directory in the Linux Crypto Provider package. It contains a <code class="language-plaintext highlighter-rouge">README.md</code> file with further information.</p>

<p>All of the provided scripts can also be executed outside of a Docker container. However, we recommend to perform the signing operations in a container to keep the dependencies in one manageable place, especially for GPG based signing tools.</p>

<h2 id="installation">Installation</h2>

<p>Depending on the signing tool you‚Äôre using, the corresponding Crypto Provider needs to be installed (on all build nodes).</p>

<ul>
  <li><strong>SignPath KSP or CSP</strong> for <a href="#signtool">SignTool.exe</a> and most native Windows tools</li>
  <li><strong>SignPath Cryptoki</strong> for <a href="#openssl">OpenSSL</a>, <a href="#jarsigner">jarsigner</a>, and many other Open Source tools</li>
</ul>

<h3 id="csp-ksp-installation">CSP/KSP installation (Windows)</h3>

<p>To install both CSP and KSP,</p>

<ol>
  <li>
    <p>Copy the contents of the <code class="language-plaintext highlighter-rouge">Windows</code> directory of the Crypto Providers ZIP archive to the target system.</p>
  </li>
  <li>
    <p>Run the following command with Administrator privileges in the destination directory:</p>

    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">powershell</span><span class="w"> </span><span class="nt">-ExecutionPolicy</span><span class="w"> </span><span class="nx">RemoteSigned</span><span class="w"> </span><span class="o">.</span><span class="nx">\InstallCspKsp.ps1</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>Continue with the <a href="#crypto-provider-configuration">configuration</a>.</p>
  </li>
</ol>

<p>Alternatively, you can also run <code class="language-plaintext highlighter-rouge">.\InstallCspKsp.ps1</code> within a PowerShell or PowerShell Core session.</p>

<div class="panel info">
  <div class="panel-header">Verification</div>

  <p>To verify the successful registration of the CSP and KSP, you can use the following command:</p>

  <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">certutil</span><span class="w"> </span><span class="nt">-csplist</span><span class="w">
</span></code></pre></div>  </div>

  <p>It should contain two entries:</p>

  <ul>
    <li><code class="language-plaintext highlighter-rouge">Provider Name: SignPathCSP</code></li>
    <li><code class="language-plaintext highlighter-rouge">Provider Name: SignPathKSP</code></li>
  </ul>

</div>

<p>CSPs <a href="https://learn.microsoft.com/en-us/windows/win32/seccrypto/cryptographic-service-providers">are deprecated by Microsoft</a> and therefore most tools only require a KSP. In case you only want to install the KSP, use the following command:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">powershell</span><span class="w"> </span><span class="nt">-ExecutionPolicy</span><span class="w"> </span><span class="nx">RemoteSigned</span><span class="w"> </span><span class="o">.</span><span class="nx">\InstallCspKsp.ps1</span><span class="w"> </span><span class="nt">-InstallParts</span><span class="w"> </span><span class="nx">KSP</span><span class="w">
</span></code></pre></div></div>

<h3 id="update-to-a-new-version">Update to a new version</h3>

<p>Installing a new version will overwrite the existing installation.</p>

<h3 id="uninstallation">Uninstallation</h3>

<p>Run the following command with Administrator privileges in the installation directory:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">powershell</span><span class="w"> </span><span class="nt">-ExecutionPolicy</span><span class="w"> </span><span class="nx">RemoteSigned</span><span class="w"> </span><span class="o">.</span><span class="nx">\InstallCspKsp.ps1</span><span class="w"> </span><span class="nx">Uninstall</span><span class="w">
</span></code></pre></div></div>

<p>This removes both the CSP and KSP version (in case they are installed).</p>

<h3 id="cryptoki">Cryptoki</h3>

<p>Simply copy-deploy the <code class="language-plaintext highlighter-rouge">Windows\SignPath.Cryptoki.dll</code> (Windows) resp. <code class="language-plaintext highlighter-rouge">Linux/libSignPath.Cryptoki/</code>‚Äã<code class="language-plaintext highlighter-rouge">&lt;OpenSslVersion&gt;/</code>‚Äã<code class="language-plaintext highlighter-rouge">libSignPath.Cryptoki.so</code> (Linux) library file of the Crypto Providers ZIP archive. To choose the right OpenSSL version, check the output of <code class="language-plaintext highlighter-rouge">openssl version</code> on your target system.</p>

<p>The various <a href="#cryptoki-signing-tools">signing tools</a> require the target system‚Äôs file path of the library file in their configurations.</p>

<h2 id="crypto-provider-configuration">Crypto Provider configuration</h2>

<h3 id="crypto-provider-config-values">Setting configuration values</h3>

<p>This section describes how to specify configuration settings for all Crypto Providers.</p>

<p>You can either use a JSON configuration file and specify the JSON file path via the <code class="language-plaintext highlighter-rouge">SIGNPATH_CONFIG_FILE</code> environment variable, or use individual configuration environment variables per setting.
Note that environment variables take precedence over the corresponding JSON settings.</p>
<table>
    <thead>
        <tr><th>

Setting (in JSON file) 
</th><th>

Environment variable 
</th><th>

Default Value 
</th><th>

Description 
</th></tr>
    </thead>
    <tbody><tr><td>

        <p><code class="language-plaintext highlighter-rouge">OrganizationId</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">SIGNPATH_ORGANIZATION_</code>‚Äã<code class="language-plaintext highlighter-rouge">ID</code></p>
      </td><td>

        <p>(mandatory)</p>
      </td><td>

        <p>The id of the organization to use</p>
      </td></tr><tr><td>

        <p><code class="language-plaintext highlighter-rouge">ApiToken</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">SIGNPATH_API_TOKEN</code></p>
      </td><td>

        <p>(mandatory)</p>
      </td><td>

        <p>The API token for a CI or Interactive User (can be created in the ‚ÄúUsers and Groups‚Äù UI). See below for options.</p>

      </td></tr><tr><td>

        <p><code class="language-plaintext highlighter-rouge">TlsClientCertificate</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">SIGNPATH_TLS_</code>‚Äã<code class="language-plaintext highlighter-rouge">CLIENT_CERTIFICATE</code></p>
      </td><td>

        <p>(-)</p>
      </td><td>

        <p>Reference to a TLS/SSL client authentication certificate in the format <code class="language-plaintext highlighter-rouge">thumbprint:</code>‚Äã<code class="language-plaintext highlighter-rouge">$HexThumbprint</code> (optional, Windows only)</p>

      </td></tr><tr><td>

        <p><code class="language-plaintext highlighter-rouge">ApiUrl</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">SIGNPATH_API_URL</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">https://</code>‚Äã<code class="language-plaintext highlighter-rouge">app.signpath.io/</code>‚Äã<code class="language-plaintext highlighter-rouge">Api</code></p>
      </td><td>

        <p>The SignPath API endpoint to use. Needs to be set if for self-hosted SignPath installations.</p>

      </td></tr><tr><td>

        <p><code class="language-plaintext highlighter-rouge">HttpProxy</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">http_proxy</code></p>
      </td><td>

        <p>(-)</p>
      </td><td>

        <p>The address of an <a href="#http-proxy-config">HTTP (web) proxy</a> (optional).</p>

      </td></tr><tr><td>

        <p><code class="language-plaintext highlighter-rouge">Timeouts.HttpRequest</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">SIGNPATH_TIMEOUTS_</code>‚Äã<code class="language-plaintext highlighter-rouge">HTTP_REQUEST</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">30</code></p>
      </td><td>

        <p>The timeout for the HTTP calls in seconds per attempt.</p>

      </td></tr><tr><td>

        <p><code class="language-plaintext highlighter-rouge">Timeouts.FirstRetryDelay</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">SIGNPATH_TIMEOUTS_</code>‚Äã<code class="language-plaintext highlighter-rouge">FIRST_RETRY_DELAY</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">1.16</code></p>
      </td><td rowspan="2">

        <p>The initial delay in seconds and maximum number of retries in case of failed API HTTP requests like timeouts or 503 (Service Unavailable) errors. The delay between the retries increases exponentially and sums up to a total delay time of 10 mins for the default values of 10 retries with 1.16 seconds initial delay.</p>

      </td></tr><tr><td>

        <p><code class="language-plaintext highlighter-rouge">Timeouts.RetryCount</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">SIGNPATH_TIMEOUTS_</code>‚Äã<code class="language-plaintext highlighter-rouge">RETRY_COUNT</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">10</code></p>
      </td><td>

      </td></tr><tr><td>

        <p><code class="language-plaintext highlighter-rouge">Log.Console.Level</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">SIGNPATH_LOG_CONSOLE_</code>‚Äã<code class="language-plaintext highlighter-rouge">LEVEL</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">none</code></p>
      </td><td>

        <p>The log level used for console logging.</p>
      </td></tr><tr><td>

        <p><code class="language-plaintext highlighter-rouge">Log.File.Level</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">SIGNPATH_LOG_FILE_LEVEL</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">warning</code></p>
      </td><td>

        <p>The log level used for file logging.</p>
      </td></tr><tr><td>

        <p><code class="language-plaintext highlighter-rouge">Log.File.Directory</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">SIGNPATH_LOG_FILE_</code>‚Äã<code class="language-plaintext highlighter-rouge">DIRECTORY</code></p>
      </td><td>

        <p>(-)</p>
      </td><td>

        <p>The path to the folder where log files should be stored. Logging to files is disabled if no value is provided.</p>

      </td></tr><tr><td>

        <p><code class="language-plaintext highlighter-rouge">Cryptoki.</code>‚Äã<code class="language-plaintext highlighter-rouge">DoNotFailOn</code>‚Äã<code class="language-plaintext highlighter-rouge">ReadWriteSessions</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">SIGNPATH_CRYPTOKI_</code>‚Äã<code class="language-plaintext highlighter-rouge">DO_NOT_FAIL_ON_</code>‚Äã<code class="language-plaintext highlighter-rouge">READ_WRITE_SESSIONS</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">false</code></p>
      </td><td>

        <p>Enables compatibility with Cryptoki / PKCS #11 clients which open sessions with read/write option (e.g. pkcs11-tool in version lower than 0.23)</p>

      </td></tr></tbody>
</table>
<p>Supported log levels: <code class="language-plaintext highlighter-rouge">none</code>, <code class="language-plaintext highlighter-rouge">fatal</code>, <code class="language-plaintext highlighter-rouge">error</code>, <code class="language-plaintext highlighter-rouge">warning</code>, <code class="language-plaintext highlighter-rouge">info</code>, <code class="language-plaintext highlighter-rouge">debug</code>, <code class="language-plaintext highlighter-rouge">verbose</code>.</p>

<p>Sample configuration file:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"ApiUrl"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://app.signpath.io/Api"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"OrganizationId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;OrganizationId&gt;"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"ApiToken"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;ApiToken&gt;"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Log"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"Console"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"Level"</span><span class="p">:</span><span class="w"> </span><span class="s2">"warning"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"File"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"Level"</span><span class="p">:</span><span class="w"> </span><span class="s2">"info"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Directory"</span><span class="p">:</span><span class="w"> </span><span class="s2">"C:</span><span class="se">\\</span><span class="s2">SignPath</span><span class="se">\\</span><span class="s2">Logs"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="api-token-options">Options for providing the API token</h3>

<p>The <code class="language-plaintext highlighter-rouge">ApiToken</code> value can contain the API token in one of the following variants:</p>
<table>
    <thead>
        <tr><th>

Value 
</th><th>

Example 
</th></tr>
    </thead>
    <tbody><tr><td>

        <p>Unencrpyted token</p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">AIk/65sl23lA1nVV/</code>‚Äã<code class="language-plaintext highlighter-rouge">pgSqk96SvHFs</code>‚Äã<code class="language-plaintext highlighter-rouge">Sw3xitmp5Qhr+F/</code></p>
      </td></tr><tr><td>

        <p>DPAPI-encrypted token (Windows only)</p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">encrypted:</code>‚Äã<code class="language-plaintext highlighter-rouge">AQAAANCMnd8BFdERjHoAwE/</code>‚Äã<code class="language-plaintext highlighter-rouge">Cl+sBAAA...</code></p>
      </td></tr><tr><td>

        <p>Registry path to DPAPI-encrypted token (Windows only)</p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">registry:</code>‚Äã<code class="language-plaintext highlighter-rouge">HKEY_CURRENT_USER\</code>‚Äã<code class="language-plaintext highlighter-rouge">SOFTWARE\SignPath\</code>‚Äã<code class="language-plaintext highlighter-rouge">MyEncryptedApiToken</code></p>
      </td></tr></tbody>
</table>
<p>In order to encrypt the token, you can use the following PowerShell snippet:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ApiToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"..."</span><span class="w">

</span><span class="c"># Encrypt ApiToken with DPAPI and encode it in Base64 format</span><span class="w">
</span><span class="n">Add-Type</span><span class="w"> </span><span class="nt">-AssemblyName</span><span class="w"> </span><span class="nx">System.Security</span><span class="w">
</span><span class="nv">$ApiTokenBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">UTF8.GetBytes</span><span class="p">(</span><span class="nv">$ApiToken</span><span class="p">)</span><span class="w">
</span><span class="nv">$EncryptedApiToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Security.Cryptography.ProtectedData</span><span class="p">]::</span><span class="n">Protect</span><span class="p">(</span><span class="nv">$ApiTokenBytes</span><span class="p">,</span><span class="w"> </span><span class="bp">$null</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">System.Security.Cryptography.DataProtectionScope</span><span class="p">]::</span><span class="n">CurrentUser</span><span class="p">)</span><span class="w">

</span><span class="nv">$EncryptedBase64EncodedApiToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Convert</span><span class="p">]::</span><span class="n">ToBase64String</span><span class="p">(</span><span class="nv">$EncryptedApiToken</span><span class="p">)</span><span class="w">

</span></code></pre></div></div>

<p>To store the encrypted token in the Windows registry, you can use the following snippet:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ApiTokenRegistryValueName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"MyEncryptedApiToken"</span><span class="w">

</span><span class="c"># Write encrypted &amp; encoded ApiToken to registry</span><span class="w">
</span><span class="n">New-Item</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="s2">"HKCU:\SOFTWARE\"</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nx">SignPath</span><span class="w">
</span><span class="n">New-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="s2">"HKCU:\SOFTWARE\SignPath"</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s2">"</span><span class="nv">$ApiTokenRegistryValueName</span><span class="s2">"</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="s2">"</span><span class="nv">$EncryptedBase64EncodedApiToken</span><span class="s2">"</span><span class="w"> </span><span class="nt">-PropertyType</span><span class="w"> </span><span class="s2">"String"</span><span class="w">
</span></code></pre></div></div>

<h3 id="http-proxy-config">HTTP Proxy configuration</h3>

<p>Optionally an HTTP web proxy can be used for the outgoing API requests.</p>

<p>On Windows by default the WinINet (‚ÄúInternet Options‚Äù) proxy settings are respected.</p>

<p>Alternatively, a proxy server can be specified in the <a href="#crypto-provider-config-values">configuration</a> (Windows and Linux) using the following value formats:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">$ProxyHost:$ProxyPort</code></li>
  <li><code class="language-plaintext highlighter-rouge">http://$ProxyHost:$ProxyPort</code></li>
</ul>

<p>In case this configuration value is set, it overrides the system‚Äôs proxy settings on Windows.</p>

<h2 id="signpath-project-configuration">SignPath Project configuration</h2>

<p>In order to perform hash-based signing with the Crypto Providers, perform the following steps in the SignPath UI:</p>

<ol>
  <li>Create a new <em>Project</em> with an <em>Artifact Configuration</em> of type <em>Hash signing data</em> and remember the <em>Project slug</em>.
<!-- TODO must be default artifact configuration? --></li>
  <li>Create an dedicated CI User (recommended) or generate an API Token for your own Interactive User and remember the API token.</li>
  <li>Create a <em>Signing Policy</em> for the <em>Project</em> and add a <em>the CI or Interactive User</em> as a <em>Submitter</em>. Remember <em>Signing Policy slug</em>.</li>
</ol>

<h2 id="windows-ksp-csp-signing-tools">Signing tools based on Windows KSP or CSP Crypto Provider</h2>

<h3 id="general-instructions">General instructions</h3>

<p>This section provides information to use SignPath with any tool that supports KSP or CSP providers. Below this section you will find instructions for specific tools.</p>

<p>Specify the following values using the parameters provided by your signing tool:</p>
<table>
    <thead>
        <tr><th>

Parameter 
</th><th>

Value 
</th><th>

Description 
</th></tr>
    </thead>
    <tbody><tr><td>

        <p>Crypto Provider</p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">SignPathKSP</code> or <code class="language-plaintext highlighter-rouge">SignPathCSP</code></p>
      </td><td>

        <p>SignPath KSP (preferred) or CSP</p>
      </td></tr><tr><td>

        <p>Key container name</p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">&lt;ProjectSlug&gt;/</code>‚Äã<code class="language-plaintext highlighter-rouge">SigningPolicySlug&gt;</code></p>
      </td><td>

        <p><em>Project</em> and <em>Signing Policy</em> slug, separated by a forward slash (<code class="language-plaintext highlighter-rouge">/</code>)</p>
      </td></tr><tr><td>

        <p>Certificate file</p>
      </td><td>

        <p>Path to the x.509 certificate file</p>
      </td><td>

        <p>Download the respective certificate file from SignPath</p>
      </td></tr></tbody>
</table>
<div class="panel info">
  <div class="panel-header">Keys are not specified directly</div>

  <p>The KSP and CSP interfaces expect you to identify a key, but SignPath requires you to specify <em>Project</em> and <em>Signing Policy</em>. SignPath will select the correct key or certificate based on the <em>Project</em> and <em>Signing Policy</em> you specify.</p>

</div>

<h3 id="error-return-values-for-ksp-and-csp-functions">Error return values for KSP and CSP functions</h3>

<p>The following table shows the KSP <code class="language-plaintext highlighter-rouge">HRESULT</code> result codes for the different error situations when calling the SignPath REST API.
Note that the CSP error code has to be retrieved via <a href="https://learn.microsoft.com/en-us/windows/win32/api/errhandlingapi/nf-errhandlingapi-getlasterror"><code class="language-plaintext highlighter-rouge">GetLastError()</code></a>.</p>
<table>
    <thead>
        <tr><th style="width: 50%">

Situation 
</th><th style="width: 50%">

KSP error result code resp. CSP <code class="language-plaintext highlighter-rouge">GetLastError()</code> code 
</th></tr>
    </thead>
    <tbody><tr><td>

        <p>Transient errors like HTTP timeouts or 503 (Service Unavailable) which still occur after the last retry</p>

      </td><td>

        <p><code class="language-plaintext highlighter-rouge">NTE_DEVICE_NOT_READY</code> (‚ÄúThe device that is required by this cryptographic provider is not ready for use.‚Äù) for errors without an HTTP status code. Otherwise, HTTP status code as an HRESULT in the <code class="language-plaintext highlighter-rouge">FACILITY_ITF</code>, e.g. <code class="language-plaintext highlighter-rouge">0x800401F7</code> for HTTP 503</p>

      </td></tr><tr><td>

        <p>Non-transient service errors (e.g. 500 Internal Server Error)</p>

      </td><td>

        <p>HTTP status code as an HRESULT in the <code class="language-plaintext highlighter-rouge">FACILITY_ITF</code>, e.g. <code class="language-plaintext highlighter-rouge">0x800401F4</code> for HTTP 500</p>

      </td></tr><tr><td>

        <p>User errors detected by service (4xx returned)</p>

      </td><td>

        <p>HTTP status code as an HRESULT in the <code class="language-plaintext highlighter-rouge">FACILITY_ITF</code>, e.g. <code class="language-plaintext highlighter-rouge">0x80040190</code> for HTTP 400</p>

      </td></tr><tr><td>

        <p>Other unspecified errors (fall back)</p>

      </td><td>

        <p><code class="language-plaintext highlighter-rouge">NTE_FAIL</code> (‚ÄúAn internal error occurred.‚Äù)</p>

      </td></tr></tbody>
</table>
<h3 id="signtool">SignTool.exe</h3>

<p><em><a href="https://docs.microsoft.com/en-us/dotnet/framework/tools/signtool-exe">SignTool.exe</a></em> is a command line tool by Microsoft. <em>SignTool.exe</em> can use both the SignPath CSP and the SignPath KSP. We recommend using the SignPath KSP whenever possible.</p>

<div class="panel warning">
  <div class="panel-header">Important</div>

  <p>Only the 64-bit version of <em>SignTool.exe</em> is supported.</p>

</div>

<h4 id="invocation">Invocation</h4>

<p><em>SignTool.exe</em> requires the following parameters:</p>
<table>
    <thead>
        <tr><th>

Parameter 
</th><th>

Value 
</th><th>

Description 
</th></tr>
    </thead>
    <tbody><tr><td>

        <p><code class="language-plaintext highlighter-rouge">/csp</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">SignPathKSP</code> or <code class="language-plaintext highlighter-rouge">SignPathCSP</code></p>
      </td><td>

        <p>SignPath KSP (preferred) or CSP</p>
      </td></tr><tr><td>

        <p><code class="language-plaintext highlighter-rouge">/kc</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">&lt;ProjectSlug&gt;/</code>‚Äã<code class="language-plaintext highlighter-rouge">&lt;SigningPolicySlug&gt;</code></p>
      </td><td>

        <p>Key container name: <em>Project</em> and <em>Signing Policy</em> slug, separated by a forward slash (<code class="language-plaintext highlighter-rouge">/</code>)</p>

      </td></tr><tr><td>

        <p><code class="language-plaintext highlighter-rouge">/fd</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">SHA256</code>, <code class="language-plaintext highlighter-rouge">SHA384</code> or <code class="language-plaintext highlighter-rouge">SHA512</code></p>
      </td><td>

        <p>Digest (hashing) algorithm</p>
      </td></tr><tr><td>

        <p><code class="language-plaintext highlighter-rouge">/f</code></p>
      </td><td>

        <p>Path to the certificate file</p>
      </td><td>

        <p>Download the respective certificate file from SignPath</p>
      </td></tr></tbody>
</table>
<p>Sample: sign <code class="language-plaintext highlighter-rouge">MyApp.exe</code></p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">signtool.exe</span><span class="w"> </span><span class="nx">sign</span><span class="w"> </span><span class="nx">/csp</span><span class="w"> </span><span class="nx">SignPathKSP</span><span class="w"> </span><span class="nx">/kc</span><span class="w"> </span><span class="s2">"</span><span class="nv">$ProjectSlug</span><span class="s2">/</span><span class="nv">$SigningPolicySlug</span><span class="s2">"</span><span class="w"> </span><span class="nx">/fd</span><span class="w"> </span><span class="nx">SHA256</span><span class="w"> </span><span class="nx">/f</span><span class="w"> </span><span class="s2">"certificate.cer"</span><span class="w"> </span><span class="s2">"MyApp.exe"</span><span class="w">
</span></code></pre></div></div>

<div class="panel tip">
  <div class="panel-header">Tip: Diagnostics</div>

  <p>Specify <code class="language-plaintext highlighter-rouge">/v</code> to enable verbose output.</p>

</div>

<div class="panel warning">
  <div class="panel-header">Warning: Produce correct timestamps</div>

  <p>When using SignTool.exe (or any other signing tool) directly, you are responsible for correct time stamping. See <a href="#timestamps">Timestamps</a></p>

</div>

<h2 id="cryptoki-signing-tools">Signing tools based on Cryptoki/PKCS #11 (Windows and Linux)</h2>

<h3 id="general-instructions-1">General instructions</h3>

<p>This section provides information how to use the SignPath Cryptoki library with any tool that supports Cryptoki. Below this section you will find instructions for specific tools.</p>

<h4 id="cryptoki-parameters">Parameters</h4>

<p>Cryptoki-enabled tools usually provide the following parameters:</p>
<table>
    <thead>
        <tr><th>

Parameter 
</th><th>

Value for the SignPath Cryptoki Library 
</th><th>

Description 
</th></tr>
    </thead>
    <tbody><tr><td>

        <p>PIN</p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">CONFIG</code> or <code class="language-plaintext highlighter-rouge">&lt;OrganizationId&gt;:&lt;ApiToken&gt;</code></p>
      </td><td>

        <p>Either use <code class="language-plaintext highlighter-rouge">CONFIG</code> to use the values from the <a href="#crypto-provider-config-values">configuration file or environment variables</a>, or directly specify a SignPath <em>Organization ID</em> and <em>API token</em> for the CI or Interactive User that was added as a submitter, separated by a colon (<code class="language-plaintext highlighter-rouge">:</code>)</p>

      </td></tr><tr><td>

        <p>Key ID</p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">&lt;ProjectSlug&gt;/</code>‚Äã<code class="language-plaintext highlighter-rouge">&lt;SigningPolicySlug&gt;</code></p>
      </td><td>

        <p>SignPath <em>Project</em> slug and <em>Signing Policy</em> slug, separated by a forward slash (<code class="language-plaintext highlighter-rouge">/</code>)</p>

      </td></tr></tbody>
</table>
<div class="panel info">
  <div class="panel-header">Keys are not specified directly</div>

  <p>The Cryptoki API expects you to identify a key, but SignPath requires you to specify a <em>Project</em> and a <em>Signing Policy</em>. SignPath will select the correct key or certificate based on the <em>Project</em> and <em>Signing Policy</em> you specify.</p>

</div>

<p>How these parameters can be specified depends on the tool being used. Since not all tools support Cryptoki directly, parameters are sometimes passed indirectly or using a specific syntax for an existing tool parameter (see the next section).</p>

<h4 id="integration-with-signing-tools">Integration with signing tools</h4>

<p>For Cryptoki-based signing, tool setup can be complex. Unlike the KSP/CSP provider architecture of Windows, Cryptoki is not a system API. As a consequence, support for Cryptoki libraries varies significantly between tools:</p>

<ul>
  <li>A tool might directly support Cryptoki (and will provide a parameter or configuration option to specify the Cryptoki library and key identifier)</li>
  <li>A tool might support different engines. If it doesn‚Äôt come with a Cryptoki engine, you need to get it from another source and install it. In this case you need to
    <ul>
      <li>specify the engine in the tool‚Äôs configuration or parameter list,</li>
      <li><em>and</em> specify the SignPath Cryptoki library in the engine‚Äôs configuration</li>
    </ul>
  </li>
  <li>A tool might internally call another tool such as OpenSSL or GPG to create the signature</li>
</ul>

<p>If your signing tool does not provide guidance for using Cryptoki libraries, you probably need a solid understanding of the specific tool chain to configure it. For better results, please also refer to <a href="#flow">signing flow</a>.</p>

<h4 id="error-return-values-for-cryptokipkcs-11-functions">Error return values for Cryptoki/PKCS #11 functions</h4>

<p>The following table shows the <a href="https://docs.oasis-open.org/pkcs11/pkcs11-base/v2.40/os/pkcs11-base-v2.40-os.html">PKCS #11</a> Cryptoki function return values for the different error situations when calling the SignPath REST API.</p>
<table>
    <thead>
        <tr><th>

Situation 
</th><th>

PKCS 
</th></tr>
    </thead>
    <tbody><tr><td>

        <p>Transient errors like HTTP timeouts or 503</p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">CKR_FUNCTION_FAILED</code></p>
      </td></tr><tr><td>

        <p>Non-transient service errors (e.g. 500 Internal Server Error)</p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">CKR_DEVICE_ERROR</code></p>
      </td></tr><tr><td>

        <p>User errors detected by service (4xx returned)</p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">CKR_ARGUMENTS_BAD</code></p>
      </td></tr><tr><td>

        <p>Other unspecified errors (fall back)</p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">CKR_GENERAL_ERROR</code></p>
      </td></tr></tbody>
</table>
<h3 id="openssl">OpenSSL</h3>

<p><em><a href="https://www.openssl.org/">OpenSSL</a></em> is a toolkit that provides a range of cryptographic operations, including signing. This section describes how to use OpenSSL with the SignPath Cryptoki library.</p>

<div class="panel warning">
  <div class="panel-header">Important</div>

  <p>Only latest OpenSSL 1.1 and 3.x versions are supported. For Linux, see also the notes in <a href="#supported-linux-distributions">supported Linux distributions</a>.</p>
</div>

<h3 id="prerequisites">Prerequisites</h3>

<p><em>OpenSSL</em> cannot directly communicate with a Cryptoki library. Instead, the <a href="https://github.com/OpenSC/libp11">OpenSC pkcs11 OpenSSL engine</a> can be used as adapter between OpenSSL and the SignPath Cryptoki/PKCS #11 library.</p>

<p><strong>Windows:</strong> Download <code class="language-plaintext highlighter-rouge">libp11-...-windows.zip </code> from <a href="https://github.com/OpenSC/libp11/releases">OpenSC libp11 Releases</a> and copy-deploy <code class="language-plaintext highlighter-rouge">pkcs11.dll</code> (x64 version).</p>

<p><strong>Linux:</strong> Install the OpenSC pkcs11 engine via your package manager (e.g. <code class="language-plaintext highlighter-rouge">apt-get install libengine-pkcs11-openssl</code> in Ubuntu).</p>

<p>Sample: <code class="language-plaintext highlighter-rouge">openssl-signpath.cnf</code></p>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">config_diagnostics</span> <span class="p">=</span> <span class="s">1</span>
<span class="py">openssl_conf</span> <span class="p">=</span> <span class="s">openssl_init</span>

<span class="nn">[openssl_init]</span>
<span class="py">engines</span> <span class="p">=</span> <span class="s">engines_section</span>

<span class="nn">[engines_section]</span>
<span class="py">pkcs11</span> <span class="p">=</span> <span class="s">pkcs11_section</span>

<span class="nn">[pkcs11_section]</span>
<span class="py">engine_id</span> <span class="p">=</span> <span class="s">pkcs11</span>
<span class="py">dynamic_path</span> <span class="p">=</span> <span class="s">/path/to/libpkcs11.so</span>
<span class="py">MODULE_PATH</span> <span class="p">=</span> <span class="s">/path/to/libSignPath.Cryptoki.so</span>
<span class="py">default_algorithms</span> <span class="p">=</span> <span class="s">ALL</span>
<span class="py">init</span> <span class="p">=</span> <span class="s">0</span>
<span class="py">PIN</span> <span class="p">=</span> <span class="s">CONFIG</span>
</code></pre></div></div>

<div class="panel info">
  <div class="panel-header">Default installation paths of libp11</div>

  <p>Note that Linux distributions have different default installation paths for <code class="language-plaintext highlighter-rouge">libpkcs11.so</code>:</p>
  <table>
    <thead>
        <tr><th>

Distribution 
</th><th>

Default path 
</th></tr>
    </thead>
    <tbody><tr><td>

          <p>Debian/Ubuntu w/ OpenSSL 1.1</p>
        </td><td>

          <p><code class="language-plaintext highlighter-rouge">/usr/lib/x86_64-linux-gnu/engines-1.1/libpkcs11.so</code></p>
        </td></tr><tr><td>

          <p>Debian/Ubuntu w/ OpenSSL 3.x</p>
        </td><td>

          <p><code class="language-plaintext highlighter-rouge">/usr/lib/x86_64-linux-gnu/engines-3/libpkcs11.so</code></p>
        </td></tr><tr><td>

          <p>RedHat w/ OpenSSL 1.1</p>
        </td><td>

          <p><code class="language-plaintext highlighter-rouge">/usr/lib64/engines-1.1/libpkcs11.so</code></p>
        </td></tr><tr><td>

          <p>RedHat w/ OpenSSL 3.x</p>
        </td><td>

          <p><code class="language-plaintext highlighter-rouge">/usr/lib64/engines-3/libpkcs11.so</code></p>
        </td></tr></tbody>
</table>
</div>

<p>For Windows use .dll paths respectively (note the double backslashes):</p>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">dynamic_path</span> <span class="p">=</span> <span class="s">C:</span><span class="se">\\</span><span class="s">path</span><span class="se">\\</span><span class="s">to</span><span class="se">\\</span><span class="s">pkcs11.dll</span>
<span class="py">MODULE_PATH</span> <span class="p">=</span> <span class="s">C:</span><span class="se">\\</span><span class="s">path</span><span class="se">\\</span><span class="s">to</span><span class="se">\\</span><span class="s">SignPath.Cryptoki.dll</span>
</code></pre></div></div>

<p>Also set the following environment variable:</p>
<table>
    <thead>
        <tr><th>

Environment variable 
</th><th>

Value 
</th><th>

Description 
</th></tr>
    </thead>
    <tbody><tr><td>

        <p><code class="language-plaintext highlighter-rouge">OPENSSL_CONF</code></p>
      </td><td>

        <p>Path to <code class="language-plaintext highlighter-rouge">openssl-signpath.cnf</code> file</p>
      </td><td>

        <p>This variable tells OpenSSL to load the custom configuration file</p>
      </td></tr></tbody>
</table>
<h4 id="invocation-1">Invocation</h4>

<p><em>OpenSSL</em> provides a variety of commands that can be used for signing. In this section, a few of them are outlined.</p>

<div class="panel tip">
  <div class="panel-header">Tip</div>

  <p>For <em>Linux</em>, configuration, signing invocation and verification examples are provided in the Docker container samples via <code class="language-plaintext highlighter-rouge">.\RunScenario.ps1 ... -Scenario OpenSSL</code>. See <a href="#linux-docker-samples">Linux container samples</a>.</p>

</div>

<p>Generally, all commands require the following parameters to work with the SignPath Cryptoki library:</p>
<table>
    <thead>
        <tr><th>

Parameter 
</th><th>

Value 
</th><th>

Description 
</th></tr>
    </thead>
    <tbody><tr><td>

        <p><code class="language-plaintext highlighter-rouge">-keyform</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">engine</code></p>
      </td><td>

        <p>Use the specified engine to access the key.</p>
      </td></tr><tr><td>

        <p><code class="language-plaintext highlighter-rouge">-engine</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">pkcs11</code></p>
      </td><td>

        <p>Use the <em>libp11</em> engine specified in the <code class="language-plaintext highlighter-rouge">openssl-signpath.cnf</code> file.</p>
      </td></tr><tr><td>

        <p><code class="language-plaintext highlighter-rouge">-inkey</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">pkcs11:id=&lt;ProjectSlug&gt;/</code>‚Äã<code class="language-plaintext highlighter-rouge">&lt;SigningPolicySlug&gt;;</code>‚Äã<code class="language-plaintext highlighter-rouge">type=private</code></p>
      </td><td>

        <p>A PKCS #11 URI including <em>Project</em> and <em>Signing Policy</em> slug, see also <a href="#cryptoki-parameters">Cryptoki parameters</a>.</p>

      </td></tr></tbody>
</table>
<div class="panel info">
  <div class="panel-header">Keys are not specified directly</div>

  <p>The Cryptoki API expects you to identify a key, but SignPath requires you to specify a <em>Project</em> and a <em>Signing Policy</em>. SignPath will select the correct key or certificate based on the <em>Project</em> and <em>Signing Policy</em> you specify.</p>
</div>

<h4 id="openssl-dgst">openssl dgst</h4>

<p>The <em><a href="https://www.openssl.org/docs/man1.1.1/man1/dgst.html">dgst</a></em> command calculates digests of files, but can also be used to create and verify signatures.</p>

<p>Sample: sign <code class="language-plaintext highlighter-rouge">artifact.bin</code> and write the signature to <code class="language-plaintext highlighter-rouge">artifact.sig</code>.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">openssl</span><span class="w"> </span><span class="nx">dgst</span><span class="w"> </span><span class="nt">-engine</span><span class="w"> </span><span class="nx">pkcs11</span><span class="w"> </span><span class="nt">-keyform</span><span class="w"> </span><span class="nx">engine</span><span class="w"> </span><span class="nt">-sign</span><span class="w"> </span><span class="s2">"pkcs11:id=</span><span class="nv">$ProjectSlug</span><span class="s2">/</span><span class="nv">$SigningPolicySlug</span><span class="s2">;type=private"</span><span class="w"> </span><span class="nt">-sha256</span><span class="w"> </span><span class="nt">-out</span><span class="w"> </span><span class="s2">"artifact.sig"</span><span class="w"> </span><span class="s2">"artifact.bin"</span><span class="w">
</span></code></pre></div></div>

<div class="panel info">
  <div class="panel-header">Supported digests</div>

  <p>The following digests are supported: <code class="language-plaintext highlighter-rouge">sha256</code>, <code class="language-plaintext highlighter-rouge">sha384</code>, <code class="language-plaintext highlighter-rouge">sha512</code></p>
</div>

<h4 id="openssl-pkeyutl">openssl pkeyutl</h4>

<p>The <em><a href="https://www.openssl.org/docs/man1.1.1/man1/pkeyutl.html">pkeyutl</a></em> command performs low-level cryptographic operations, such as signing.</p>

<!-- todo omit?-->
<div class="panel info">
  <div class="panel-header">Note: provide binary hash digest</div>

  <p>The command does hash the input data but will use the data directly as an input for the signature algorithm. To create the hash of a file, you can use the following snippet:</p>

  <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ArtifactHash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-FileHash</span><span class="w"> </span><span class="s2">"artifact.bin"</span><span class="w"> </span><span class="nt">-Algorithm</span><span class="w"> </span><span class="s2">"SHA256"</span><span class="w"> </span><span class="c"># SHA1, SHA256, SHA384 and SHA512 are supported</span><span class="w">
</span><span class="nv">$ArtifactHashBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">byte</span><span class="p">[]]</span><span class="w"> </span><span class="o">-split</span><span class="w"> </span><span class="p">(</span><span class="nv">$ArtifactHash</span><span class="o">.</span><span class="nf">Hash</span><span class="w"> </span><span class="o">-replace</span><span class="w"> </span><span class="s1">'..'</span><span class="p">,</span><span class="w"> </span><span class="s1">'0x$&amp; '</span><span class="p">)</span><span class="w">
</span><span class="p">[</span><span class="n">IO.File</span><span class="p">]::</span><span class="n">WriteAllBytes</span><span class="p">(</span><span class="s2">"artifact.hash.bin"</span><span class="p">,</span><span class="w"> </span><span class="nv">$ArtifactHashBytes</span><span class="p">)</span><span class="w">
</span></code></pre></div>  </div>
</div>

<p>Sample: sign the hash code in <code class="language-plaintext highlighter-rouge">artifact.hash.bin</code> using PKCS1 padding, write the signature to <code class="language-plaintext highlighter-rouge">artifact.sig</code></p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">openssl</span><span class="w"> </span><span class="nx">pkeyutl</span><span class="w"> </span><span class="nt">-engine</span><span class="w"> </span><span class="nx">pkcs11</span><span class="w"> </span><span class="nt">-keyform</span><span class="w"> </span><span class="nx">engine</span><span class="w"> </span><span class="nt">-inkey</span><span class="w"> </span><span class="s2">"pkcs11:id=</span><span class="nv">$ProjectSlug</span><span class="s2">/</span><span class="nv">$SigningPolicySlug</span><span class="s2">;type=private"</span><span class="w"> </span><span class="nt">-sign</span><span class="w"> </span><span class="nt">-in</span><span class="w"> </span><span class="s2">"artifact.hash.bin"</span><span class="w"> </span><span class="nt">-out</span><span class="w"> </span><span class="s2">"artifact.sig"</span><span class="w"> </span><span class="nt">-pkeyopt</span><span class="w"> </span><span class="nx">digest:sha256</span><span class="w"> </span><span class="nt">-pkeyopt</span><span class="w"> </span><span class="nx">rsa_padding_mode:pkcs1</span><span class="w">
</span></code></pre></div></div>

<p>Sample: sign the hash code in <code class="language-plaintext highlighter-rouge">artifact.hash.bin</code> using PSS padding, write the signature to <code class="language-plaintext highlighter-rouge">artifact.sig</code></p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">openssl</span><span class="w"> </span><span class="nx">pkeyutl</span><span class="w"> </span><span class="nt">-engine</span><span class="w"> </span><span class="nx">pkcs11</span><span class="w"> </span><span class="nt">-keyform</span><span class="w"> </span><span class="nx">engine</span><span class="w"> </span><span class="nt">-inkey</span><span class="w"> </span><span class="s2">"pkcs11:id=</span><span class="nv">$ProjectSlug</span><span class="s2">/</span><span class="nv">$SigningPolicySlug</span><span class="s2">;type=private"</span><span class="w"> </span><span class="nt">-sign</span><span class="w"> </span><span class="nt">-in</span><span class="w"> </span><span class="s2">"artifact.hash.bin"</span><span class="w"> </span><span class="nt">-out</span><span class="w"> </span><span class="s2">"artifact.sig"</span><span class="w"> </span><span class="nt">-pkeyopt</span><span class="w"> </span><span class="nx">digest:sha256</span><span class="w"> </span><span class="nt">-pkeyopt</span><span class="w"> </span><span class="nx">rsa_padding_mode:pss</span><span class="w"> </span><span class="nt">-pkeyopt</span><span class="w"> </span><span class="nx">rsa_pss_saltlen:-1</span><span class="w"> </span><span class="nt">-pkeyopt</span><span class="w"> </span><span class="nx">rsa_mgf1_md:sha256</span><span class="w">
</span></code></pre></div></div>

<h4 id="openssl-cms">openssl cms</h4>

<p>The <em><a href="https://www.openssl.org/docs/man1.1.1/man1/cms.html">cms</a></em> command can be used to create embedded S/MIME or detached PEM/DER signatures. It uses the Cryptographic Message Syntax format (CMS, formerly known as PKCS#7).</p>

<p><code class="language-plaintext highlighter-rouge">openssl cms</code> requires the X.509 certificate corresponding to the SignPath Project and Signing Policy to be downloaded from SignPath and converted to <em>PEM format</em>. You can convert the certificate using OpenSSL via the following example.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">openssl</span><span class="w"> </span><span class="nx">x509</span><span class="w"> </span><span class="nt">-inform</span><span class="w"> </span><span class="nx">DER</span><span class="w"> </span><span class="nt">-in</span><span class="w"> </span><span class="s2">"certificate.cer"</span><span class="w"> </span><span class="nt">-outform</span><span class="w"> </span><span class="nx">PEM</span><span class="w"> </span><span class="nt">-out</span><span class="w"> </span><span class="s2">"certificate.pem"</span><span class="w">
</span></code></pre></div></div>

<p>Sample: sign the file <code class="language-plaintext highlighter-rouge">artifact.bin</code> using <code class="language-plaintext highlighter-rouge">certificate.pem</code>, write the detached signature to <code class="language-plaintext highlighter-rouge">artifact.sig</code> in PEM format</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">openssl</span><span class="w"> </span><span class="nx">cms</span><span class="w"> </span><span class="nt">-engine</span><span class="w"> </span><span class="nx">pkcs11</span><span class="w"> </span><span class="nt">-signer</span><span class="w"> </span><span class="s2">"certificate.pem"</span><span class="w"> </span><span class="nt">-inkey</span><span class="w"> </span><span class="s2">"pkcs11:id=</span><span class="nv">$ProjectSlug</span><span class="s2">/</span><span class="nv">$SigningPolicySlug</span><span class="s2">;type=private"</span><span class="w"> </span><span class="nt">-keyform</span><span class="w"> </span><span class="nx">engine</span><span class="w"> </span><span class="nt">-sign</span><span class="w"> </span><span class="nt">-binary</span><span class="w"> </span><span class="nt">-in</span><span class="w"> </span><span class="s2">"artifact.bin"</span><span class="w"> </span><span class="nt">-noattr</span><span class="w"> </span><span class="nt">-out</span><span class="w"> </span><span class="s2">"artifact.sig"</span><span class="w"> </span><span class="nt">-outform</span><span class="w"> </span><span class="nx">PEM</span><span class="w">
</span></code></pre></div></div>

<div class="panel warning">
  <div class="panel-header">Important</div>

  <p><em>OpenSSL</em> fails to verify signatures that were created using X.509 certificates with the Extended Key Usage Code Signing (1.3.6.1.5.5.7.3.3).</p>
</div>

<h3 id="osslsigncode">osslsigncode</h3>

<p><em><a href="https://github.com/mtrojnar/osslsigncode">osslsigncode</a></em> is a tool that allows applying Windows Authenticode signatures on Linux systems using <a href="#openssl">OpenSSL</a>.</p>

<div class="panel warning">
  <div class="panel-header">Important</div>

  <p>Only osslsigncode 2.x or higher is supported. Also see the notes in <a href="#supported-linux-distributions">supported Linux distributions</a> regarding the supported OpenSSL versions.</p>
</div>

<h4 id="prerequisites-1">Prerequisites</h4>

<p>As <a href="https://github.com/mtrojnar/osslsigncode">osslsigncode</a> uses <a href="#openssl">OpenSSL</a>, it also requires an <a href="https://github.com/OpenSC/libp11">OpenSC pkcs11 OpenSSL engine</a> installation.</p>

<h4 id="invocation-2">Invocation</h4>

<div class="panel tip">
  <div class="panel-header">Tip</div>

  <p>The following invocation examples are also provided in the Docker container samples via <code class="language-plaintext highlighter-rouge">.\RunScenario.ps1 ... -Scenario osslsigncode</code>. See <a href="#linux-docker-samples">Linux container samples</a>.</p>
</div>

<p><code class="language-plaintext highlighter-rouge">osslsigncode</code> requires the X.509 certificate corresponding to the SignPath Project and Signing Policy to be downloaded from SignPath and converted to <em>PEM format</em>. You can convert the certificate using OpenSSL via the following example.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">openssl</span><span class="w"> </span><span class="nx">x509</span><span class="w"> </span><span class="nt">-inform</span><span class="w"> </span><span class="nx">DER</span><span class="w"> </span><span class="nt">-in</span><span class="w"> </span><span class="s2">"certificate.cer"</span><span class="w"> </span><span class="nt">-outform</span><span class="w"> </span><span class="nx">PEM</span><span class="w"> </span><span class="nt">-out</span><span class="w"> </span><span class="s2">"certificate.pem"</span><span class="w">
</span></code></pre></div></div>

<h5 id="signing-an-exe-file">Signing an .exe file</h5>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">osslsigncode</span><span class="w"> </span><span class="nx">sign</span><span class="w"> </span><span class="se">`
</span><span class="w">   </span><span class="nt">-pkcs11module</span><span class="w"> </span><span class="nv">$LibSignPathCryptokiPath</span><span class="w"> </span><span class="se">`
</span><span class="w">   </span><span class="nt">-key</span><span class="w"> </span><span class="s2">"pkcs11:id=</span><span class="nv">$ProjectSlug</span><span class="s2">/</span><span class="nv">$SigningPolicySlug</span><span class="s2">;type=private;pin-value=CONFIG"</span><span class="w"> </span><span class="se">`
</span><span class="w">   </span><span class="nt">-certs</span><span class="w"> </span><span class="s2">"certificate.pem"</span><span class="w"> </span><span class="se">`
</span><span class="w">   </span><span class="nt">-in</span><span class="w"> </span><span class="s2">"sample.exe"</span><span class="w"> </span><span class="nt">-out</span><span class="w"> </span><span class="s2">"sample.signed.exe"</span><span class="w">
</span></code></pre></div></div>
<table>
    <thead>
        <tr><th>

Parameter 
</th><th>

Value 
</th><th>

Description 
</th></tr>
    </thead>
    <tbody><tr><td>

        <p><code class="language-plaintext highlighter-rouge">--pkcs11module</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">/path/to/</code>‚Äã<code class="language-plaintext highlighter-rouge">libSignPath.Cryptoki.so</code></p>
      </td><td>

        <p>Path to the SignPath Cryptoki library.</p>
      </td></tr><tr><td>

        <p><code class="language-plaintext highlighter-rouge">--key</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">pkcs11:id=...</code></p>
      </td><td>

        <p>A PKCS #11 URI as shown in the example above including <em>Project</em> and <em>Signing Policy</em> slug and the ‚Äúpin‚Äù value, see also <a href="#cryptoki-parameters">Cryptoki parameters</a>.</p>

      </td></tr><tr><td>

        <p><code class="language-plaintext highlighter-rouge">--certs</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">certificate.pem</code></p>
      </td><td>

        <p>Certificate of the used signing policy in PEM format.</p>
      </td></tr></tbody>
</table>
<h3 id="opensc-pkcs11-tool-linux">OpenSC pkcs11-tool (Linux)</h3>

<p>The <a href="https://github.com/OpenSC/OpenSC">OpenSC</a> <a href="https://linux.die.net/man/1/pkcs11-tool"><code class="language-plaintext highlighter-rouge">pkcs11-tool</code></a> utility can be used to troubleshoot PKCS #11 modules (e.g. listing all available objects or supported algorithms) but also can be used to read certificates/public keys and to perform signing operations.</p>

<h4 id="prerequisites-2">Prerequisites</h4>

<p>Before version 0.23, <code class="language-plaintext highlighter-rouge">pkcs11-tool</code> always opened the Cryptoki session in a read/write mode (see <a href="https://github.com/OpenSC/OpenSC/issues/2182">GitHub issue #2182</a>) and therefore fails with a <em>‚ÄúPKCS11 function C_OpenSession failed: rv = CKR_TOKEN_WRITE_PROTECTED‚Äù</em> error. To enable compatibility with these earlier versions you need to set the <code class="language-plaintext highlighter-rouge">Cryptoki.DoNotFailOnReadWriteSessions</code> value in the SignPath <a href="#crypto-provider-config-values">Crypto Provider configuration</a>.</p>

<h4 id="invocation-3">Invocation</h4>

<div class="panel tip">
  <div class="panel-header">Tip</div>

  <p>The following invocation examples are also provided in the Docker container samples via <code class="language-plaintext highlighter-rouge">.\RunScenario.ps1 ... -Scenario Pkcs11Tool</code>. See <a href="#linux-docker-samples">Linux container samples</a>.</p>
</div>

<h5 id="common-parameters">Common parameters</h5>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pkcs11-tool</span><span class="w"> </span><span class="nt">--module</span><span class="w"> </span><span class="nv">$LibSignPathCryptokiPath</span><span class="w"> </span><span class="nt">--pin</span><span class="w"> </span><span class="nx">CONFIG</span><span class="w"> </span><span class="o">...</span><span class="w">
</span></code></pre></div></div>
<table>
    <thead>
        <tr><th>

Parameter 
</th><th>

Value 
</th><th>

Description 
</th></tr>
    </thead>
    <tbody><tr><td>

        <p><code class="language-plaintext highlighter-rouge">--module</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">/path/to/</code>‚Äã<code class="language-plaintext highlighter-rouge">libSignPath.Cryptoki.so</code></p>
      </td><td>

        <p>Path to the SignPath Cryptoki library.</p>
      </td></tr><tr><td>

        <p><code class="language-plaintext highlighter-rouge">--pin</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">CONFIG</code> or <code class="language-plaintext highlighter-rouge">&lt;OrganizationId&gt;:&lt;ApiToken&gt;</code></p>
      </td><td>

        <p>See <a href="#cryptoki-parameters">PIN parameter</a></p>

      </td></tr></tbody>
</table>
<h5 id="listing-of-the-available-pkcs-11-objects">Listing of the available PKCS #11 objects</h5>

<p>The following command lists available objects, which corresponds to the list of signing policies for which the authenticated user has <em>Submitter</em> permissions.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pkcs11-tool</span><span class="w"> </span><span class="nt">--module</span><span class="w"> </span><span class="nv">$LibSignPathCryptokiPath</span><span class="w"> </span><span class="nt">--pin</span><span class="w"> </span><span class="nx">CONFIG</span><span class="w"> </span><span class="nt">--list-objects</span><span class="w">
</span></code></pre></div></div>

<h4 id="signing-operation">Signing operation</h4>

<p>The following sample call shows an RSA signing operation using PSS padding and SHA-256.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pkcs11-tool</span><span class="w"> </span><span class="nt">--module</span><span class="w"> </span><span class="nv">$LibSignPathCryptokiPath</span><span class="w"> </span><span class="nt">--pin</span><span class="w"> </span><span class="nx">CONFIG</span><span class="w"> </span><span class="se">`
</span><span class="w">   </span><span class="nt">--sign</span><span class="w"> </span><span class="nt">--mechanism</span><span class="w"> </span><span class="s2">"RSA-PKCS-PSS"</span><span class="w"> </span><span class="nt">--hash-algorithm</span><span class="w"> </span><span class="s2">"SHA256"</span><span class="w"> </span><span class="nt">--label</span><span class="w"> </span><span class="s2">"</span><span class="nv">$ProjectSlug</span><span class="s2">/</span><span class="nv">$SigningPolicySlug</span><span class="s2">"</span><span class="w"> </span><span class="se">`
</span><span class="w">   </span><span class="nt">--input-file</span><span class="w"> </span><span class="s2">"artifact.hash.bin"</span><span class="w"> </span><span class="nt">--output-file</span><span class="w"> </span><span class="s2">"artifact.sig"</span><span class="w">
</span></code></pre></div></div>
<table>
    <thead>
        <tr><th>

Parameter 
</th><th>

Value 
</th><th>

Description 
</th></tr>
    </thead>
    <tbody><tr><td>

        <p><code class="language-plaintext highlighter-rouge">--mechanism</code></p>
      </td><td>

        <p>e.g. <code class="language-plaintext highlighter-rouge">RSA-PKCS-PSS</code></p>
      </td><td>

        <p>Use the <code class="language-plaintext highlighter-rouge">--list-mechanisms</code> argument to list all available mechanisms</p>

      </td></tr><tr><td>

        <p><code class="language-plaintext highlighter-rouge">--hash-algorithm</code></p>
      </td><td>

        <p>e.g. <code class="language-plaintext highlighter-rouge">SHA256</code></p>
      </td><td>

        <p>Only necessary for <code class="language-plaintext highlighter-rouge">RSA-PKCS-PSS</code> mechanism</p>

      </td></tr><tr><td>

        <p><code class="language-plaintext highlighter-rouge">--label</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">&lt;ProjectSlug&gt;/</code>‚Äã<code class="language-plaintext highlighter-rouge">&lt;SigningPolicySlug&gt;</code></p>
      </td><td>

        <p><em>Project</em> and <em>Signing Policy</em> slug, separated by a forward slash (<code class="language-plaintext highlighter-rouge">/</code>)</p>

      </td></tr><tr><td>

        <p><code class="language-plaintext highlighter-rouge">--input-file</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">/path/to/hash.bin</code></p>
      </td><td>

        <p>The file containing a hash in <em>binary</em> form</p>

      </td></tr></tbody>
</table>
<h3 id="jarsigner">Java jarsigner</h3>

<p>The <a href="https://docs.oracle.com/en/java/javase/17/docs/specs/man/jarsigner.html"><code class="language-plaintext highlighter-rouge">jarsigner</code></a> command signs and verifies Java archives (e.g. JAR, WAR, EAR). It is included with the Java Development Kit (JDK).</p>

<h4 id="prerequisites-3">Prerequisites</h4>

<ol>
  <li>Configure the SunPKCS11 Provider
    <ul>
      <li>OpenJDK: the provider is configured automatically</li>
      <li>Oracle JDK: see <a href="https://docs.oracle.com/en/java/javase/14/security/pkcs11-reference-guide1.html#GUID-C4ABFACB-B2C9-4E71-A313-79F881488BB9">Oracle PKCS#11 Reference Guide</a></li>
    </ul>
  </li>
  <li>Register the SignPath Cryptoki library for the SunPKCS11 Provider</li>
</ol>

<p>Sample <code class="language-plaintext highlighter-rouge">pkcs11.config</code></p>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">name</span><span class="p">=</span><span class="s">SignPath.Cryptoki</span>
<span class="py">library</span><span class="p">=</span><span class="s">&lt;path&gt;</span><span class="se">\S</span><span class="s">ignPath.Cryptoki.dll</span>
<span class="py">slot</span><span class="p">=</span><span class="s">1</span>
</code></pre></div></div>

<h4 id="invocation-4">Invocation</h4>

<div class="panel tip">
  <div class="panel-header">Tip</div>

  <p>For <em>Linux</em>, configuration and invocation examples are provided in the Docker container samples via <code class="language-plaintext highlighter-rouge">.\RunScenario.ps1 ... -Scenario JarSigner</code>. See <a href="#linux-docker-samples">Linux container samples</a>.</p>

</div>

<p>Synopsis for <em>jarsigner</em> when using the SignPath Cryptoki library:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jarsigner &lt;parameters&gt; &lt;jar-files&gt; &lt;keystore-alias&gt;
</code></pre></div></div>
<table>
    <thead>
        <tr><th>

Parameter 
</th><th>

Value 
</th><th>

Description 
</th></tr>
    </thead>
    <tbody><tr><td>

        <p><code class="language-plaintext highlighter-rouge">-storetype</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">PKCS11</code></p>
      </td><td>

        <p>Use a PKCS11 store for the signing operation</p>
      </td></tr><tr><td>

        <p><code class="language-plaintext highlighter-rouge">-providerClass</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">sun.security.</code>‚Äã<code class="language-plaintext highlighter-rouge">pkcs11.SunPKCS11</code></p>
      </td><td>

        <p>Use the SunPKCS11 provider for the signing operation</p>
      </td></tr><tr><td>

        <p><code class="language-plaintext highlighter-rouge">-keystore</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">NONE</code></p>
      </td><td>

        <p>Key is not loaded from a file</p>
      </td></tr><tr><td>

        <p><code class="language-plaintext highlighter-rouge">-providerArg</code></p>
      </td><td>

        <p>Path to <code class="language-plaintext highlighter-rouge">pkcs11.config</code></p>
      </td><td>

        <p>The SunPKCS11 provider expects a path to the config file</p>
      </td></tr><tr><td>

        <p><code class="language-plaintext highlighter-rouge">-sigalg</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">SHA256withRSA</code>, <code class="language-plaintext highlighter-rouge">SHA384withRSA</code>, <code class="language-plaintext highlighter-rouge">SHA512withRSA</code>, <code class="language-plaintext highlighter-rouge">SHA256withECDSA</code>, <code class="language-plaintext highlighter-rouge">SHA384withECDSA</code>, or <code class="language-plaintext highlighter-rouge">SHA512withECDSA</code></p>
      </td><td>

        <p>Digest and signature algorithm</p>
      </td></tr><tr><td>

        <p><code class="language-plaintext highlighter-rouge">-storepass</code></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">CONFIG</code> or <code class="language-plaintext highlighter-rouge">&lt;OrganizationId&gt;:&lt;ApiToken&gt;</code></p>
      </td><td>

        <p>See <a href="#cryptoki-parameters">‚ÄúPIN‚Äù parameter</a></p>

      </td></tr><tr><td>

        <p><em>keystore-alias</em></p>
      </td><td>

        <p><code class="language-plaintext highlighter-rouge">&lt;ProjectSlug&gt;/</code>‚Äã<code class="language-plaintext highlighter-rouge">&lt;SigningPolicySlug&gt;</code></p>
      </td><td>

        <p><em>Project</em> and <em>Signing Policy</em> slug, separated by a forward slash (<code class="language-plaintext highlighter-rouge">/</code>)</p>

      </td></tr></tbody>
</table>
<p>Sample: sign <code class="language-plaintext highlighter-rouge">myapp.jar</code></p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">jarsigner</span><span class="w"> </span><span class="nt">-keystore</span><span class="w"> </span><span class="nx">NONE</span><span class="w"> </span><span class="nt">-storetype</span><span class="w"> </span><span class="nx">PKCS11</span><span class="w"> </span><span class="nt">-providerClass</span><span class="w"> </span><span class="s2">"sun.security.pkcs11.SunPKCS11"</span><span class="w"> </span><span class="nt">-providerArg</span><span class="w"> </span><span class="nx">pkcs11.config</span><span class="w"> </span><span class="nt">-sigalg</span><span class="w"> </span><span class="s2">"SHA256withRSA"</span><span class="w"> </span><span class="nt">-storepass</span><span class="w"> </span><span class="s2">"CONFIG"</span><span class="w"> </span><span class="nx">myapp.jar</span><span class="w"> </span><span class="s2">"</span><span class="nv">$ProjectSlug</span><span class="s2">/</span><span class="nv">$SigningPolicySlug</span><span class="s2">"</span><span class="w"> 
</span></code></pre></div></div>

<div class="panel warning">
  <div class="panel-header">Warning: Produce correct timestamps</div>

  <p>When using jarsigner (or any other signing tool) directly, you are responsible for correct time stamping. See <a href="#timestamps">Timestamps</a></p>

</div>

<h3 id="gpg-signing">GPG Signing with GnuPG (Linux)</h3>

<p>GnuPG does not directly support PKCS #11/Cryptoki but offers a <a href="https://wiki.gnupg.org/SmartCard">‚ÄúSmart Card‚Äù interface</a>, normally used to access smart card or USB token based HSMs.</p>

<p>Here the <a href="https://github.com/alonbl/gnupg-pkcs11-scd/">gnupg-pkcs11-scd</a> project comes into play, which uses the GnuPG smart card interface to adapt to a PKCS #11 Crypto Provider. This tool runs as a GnuPG smart card daemon which we use to connect GnuPG to the SignPath PKCS #11/Cryptoki Crypto Provider as shown in the following figure.</p>

<p><img src="/assets/img/resources/documentation_crypto_providers-GpgSigningFlow.svg" alt="Figure: GPG signing flow" /></p>

<h4 id="configure-gnupg">Configuring GnuPG</h4>

<p>Both GnuPG (<code class="language-plaintext highlighter-rouge">gpg-agent.conf</code>) and gnupg-pkcs11-scd (<code class="language-plaintext highlighter-rouge">gnupg-pkcs11-scd.conf</code>) need to be set up to use the SignPath Cryptoki Crypto Provider.</p>

<p>For details how these files need to be configured and about the necessary dependencies, see <code class="language-plaintext highlighter-rouge">samples/Scenarios/Gpg</code> and the <code class="language-plaintext highlighter-rouge">UseSignPathCryptokiGpgConfiguration</code> function in the <a href="#linux-docker-samples">Linux container samples</a>.</p>

<h4 id="gpg-key-generation">GPG Key Generation</h4>

<p>GPG has an own key format and therefore SignPath‚Äôs X.509 certificates cannot be directly used. Instead you have to generate a GPG key which <em>references</em> a SignPath certificate. This means creating a new GPG key which includes the RSA public key of a SignPath certificate and ‚Äúlinks‚Äù the RSA private key (which resides in SignPath‚Äôs HSMs). This is possible via a <a href="https://github.com/gpg/gnupg/blob/STABLE-BRANCH-2-2/agent/keyformat.txt#shadowed-private-key-format">‚Äúshadowed private key‚Äù</a> stored within <code class="language-plaintext highlighter-rouge">$GNUPGHOME/private-keys-v1.d/&lt;KeyGrip&gt;.key</code> which basically references a SignPath project and signing policy slug within.</p>

<p>Although the RSA key is used from the SignPath certificate, GPG keys hold their own metadata like name, email and expiration date which need to be specified during the GPG key generation. As defaults we use <code class="language-plaintext highlighter-rouge">"SignPath &lt;ProjectSlug&gt; / &lt;SigningPolicySlug&gt;</code> for the full name,  <code class="language-plaintext highlighter-rouge">"&lt;SigningPolicySlug&gt;@&lt;ProjectSlug&gt;</code> as email and 1 year expiration.</p>

<p>As the SignPath X.509 certificate‚Äôs issuer and validity time range is not used, you can use a separate self-signed certificate in SignPath with an arbitrary validity time range. Alternatively, you could also use your existing (public-trusted) code signing certificates.</p>

<p>The <a href="#linux-docker-samples">Linux container samples</a> contain scripts to generate a GPG key via <code class="language-plaintext highlighter-rouge">.\RunScenario.ps1 ... -Scenario GenerateGpgKey</code>. See <code class="language-plaintext highlighter-rouge">GenerateGpgKey.ps1</code> for details how the different commands are parametrized. In the same script the GPG key metadata defaults can be overridden.</p>

<p>The outcome of <code class="language-plaintext highlighter-rouge">GenerateGpgKey</code> is a GPG key, which is exported to <code class="language-plaintext highlighter-rouge">samples/Scenarios/Gpg/Keys</code> including the public key and a corresponding revocation certificate in the <code class="language-plaintext highlighter-rouge">openpgp-revocs.d</code> subdirectory.
The public key (<code class="language-plaintext highlighter-rouge">&lt;Email&gt;.public.pgp</code> file) needs to be transported to the system which should later perform the GPG signing operations.
Note that the shadowed private key file does not need to be transported as it can be restored by running the <code class="language-plaintext highlighter-rouge">SCD LEARN</code> command via <code class="language-plaintext highlighter-rouge">gpg-connect-agent</code> (see <code class="language-plaintext highlighter-rouge">FetchGpgKeyInfos</code> function in the Linux container samples).</p>

<p>During the GPG key generation two SignPath hash signing operations happen: One to self-sign the key and one to sign the revocation certificate.</p>

<h4 id="gpg-file-signing">GPG File Signing</h4>

<p><strong>Preparation</strong>: Before running a GPG signing operation via <code class="language-plaintext highlighter-rouge">gpg --sign ...</code>, the following steps are necessary.</p>

<ol>
  <li><a href="#gpg-key-generation">Generate a GPG key</a></li>
  <li>Copy the generated public GPG key (<code class="language-plaintext highlighter-rouge">&lt;Email&gt;.public.pgp</code>) to the target system</li>
  <li><a href="#configure-gnupg">Configure GPG</a> (After the <code class="language-plaintext highlighter-rouge">SCD LEARN</code> command, all keys which are available for the ApiToken are restored as shadowed private keys and therefore can be used by the corresponding GPG keys, see <code class="language-plaintext highlighter-rouge">UseSignPathCryptoki</code>‚Äã<code class="language-plaintext highlighter-rouge">GpgConfiguration</code> function in the Linux container samples)</li>
  <li>Import the GPG key (see <code class="language-plaintext highlighter-rouge">ImportGpgKeys</code> function in the Linux container samples)</li>
</ol>

<p>The <a href="#linux-docker-samples">Linux container samples</a> contain a full example to sign and verify a file with a detached signature (including the mentioned preparation steps) in <code class="language-plaintext highlighter-rouge">.\RunScenario.ps1 ... -Scenario GpgSignFile</code>. The used GPG key is referenced via its email address.</p>

<p>During <code class="language-plaintext highlighter-rouge">gpg --sign</code>, SignPath is called to perform a hash based signing operation with the <em>Project</em> / <em>Signing Policy</em> referenced in the shadowed private key. Note that the <em>OrganizationId</em> and the <em>ApiToken</em> still need to be passed to the SignPath Crypto Provider to authenticate the request.</p>

<h3 id="rpm-signing-linux">RPM Signing (Linux)</h3>

<p>RPM signing is based on <a href="#gpg-signing">GPG signing</a>. Therefore the preparation steps mentioned in <a href="#gpg-file-signing">GPG File Signing</a> are necessary before signing via <code class="language-plaintext highlighter-rouge">rpm --addsign</code>.</p>

<p>The <a href="#linux-docker-samples">Linux container samples</a> contain a full example to sign and verify a RPM file (including the mentioned preparation steps) in <code class="language-plaintext highlighter-rouge">.\RunScenario.ps1 ... -Scenario SignRpm</code>. The used GPG key is referenced via its email address. See <code class="language-plaintext highlighter-rouge">SignRpm.ps1</code> for details.</p>

<p>During <code class="language-plaintext highlighter-rouge">rpm --addsign</code>, SignPath is called to perform a hash based signing operation with the <em>Project</em> / <em>Signing Policy</em> referenced in the shadowed private key. Note that the <em>OrganizationId</em> and the <em>ApiToken</em> still need to be passed to the SignPath Crypto Provider to authenticate the request.</p>

<h3 id="deb-signing-via-dpkg-sig-linux">DEB Signing via dpkg-sig (Linux)</h3>

<p>Debian package signing via <a href="https://manpages.debian.org/bullseye/dpkg-sig/dpkg-sig.1.en.html">dpkg-sig</a> signing is based on <a href="#gpg-signing">GPG signing</a>. Therefore the preparation steps mentioned in <a href="#gpg-file-signing">GPG File Signing</a> are necessary before signing via <em>dpkg-sig</em>.</p>

<p>The <a href="#linux-docker-samples">Linux container samples</a> contain a full example to sign and verify a DEB file (including the mentioned preparation steps) in <code class="language-plaintext highlighter-rouge">.\RunScenario.ps1 ... -Scenario SignDeb</code>. The used GPG key is referenced via its email address. Note the passed default ‚Äúsign role‚Äù value of <code class="language-plaintext highlighter-rouge">"builder"</code>.</p>

<p>During <code class="language-plaintext highlighter-rouge">dpkg-sig --sign</code>, SignPath is called to perform a hash based signing operation with the project / signing policy referenced in the shadowed private key. Note that OrganizationId and the ApiToken still need to be passed to the SignPath Crypto Provider to authenticate the request.</p>

<h3 id="maven-artifact-signing-linux">Maven Artifact Signing (Linux)</h3>

<p>Maven artifacts can be signed with the <a href="https://maven.apache.org/plugins/maven-gpg-plugin/">Apache maven-gpg-plugin</a> which uses <a href="#gpg-signing">GPG</a> commands to sign the different artifact files (e.g. .JAR files). Therefore, the preparation steps mentioned in <a href="#gpg-file-signing">GPG File Signing</a> are necessary before signing.</p>

<p>The <a href="#linux-docker-samples">Linux container samples</a> contain a full example to build, sign and verify Maven artifacts (including the mentioned preparation steps) in <code class="language-plaintext highlighter-rouge">.\RunScenario.ps1 ... -Scenario SignMaven</code>. The used GPG key is referenced via its email address.</p>

<p>During <code class="language-plaintext highlighter-rouge">mvn install</code>, SignPath is called to perform a hash based signing operations with the <em>Project</em> / <em>Signing Policy</em> referenced in the shadowed private key. Note that the <em>OrganizationId</em> and the <em>ApiToken</em> still need to be passed to the SignPath Crypto Provider to authenticate the request.</p>

<h2 id="direct-usage-of-the-signpath-rest-api">Direct usage of the SignPath REST API</h2>

<p>As an alternative to using a Crypto Provider client, signing requests to a <a href="#signpath-project-configuration">‚ÄúHash signing data‚Äù</a> project can also be performed directly via SignPath‚Äôs REST API.</p>

<p>All API requests require the following parameters:</p>
<table>
    <thead>
        <tr><th>

Parameter 
</th><th>

Type 
</th><th>

Description 
</th></tr>
    </thead>
    <tbody><tr><td>

        <p><code class="language-plaintext highlighter-rouge">$ApiUrl</code></p>
      </td><td>

        <p>URL segment</p>
      </td><td>

        <p>The base URL of the SignPath API, e.g. <code class="language-plaintext highlighter-rouge">https://app.signpath.io/</code>‚Äã<code class="language-plaintext highlighter-rouge">Api</code></p>

      </td></tr><tr><td>

        <p><code class="language-plaintext highlighter-rouge">$OrganizationId</code></p>
      </td><td>

        <p>URL segment</p>
      </td><td>

        <p>The id of the organization to use.</p>

      </td></tr><tr><td>

        <p><code class="language-plaintext highlighter-rouge">Authorization: Bearer $ApiToken</code></p>
      </td><td>

        <p>Header</p>
      </td><td>

        <p>The API token for a CI or Interactive User (can be created in the ‚ÄúUsers and Groups‚Äù UI).</p>

      </td></tr></tbody>
</table>
<h3 id="signing-request">Signing Request</h3>

<p>The signing request (which contains the hash to sign and metadata) is an HTTP POST request to <code class="language-plaintext highlighter-rouge">$ApiUrl/v1/$OrganizationId/</code>‚Äã<code class="language-plaintext highlighter-rouge">SigningRequests</code> with the following <code class="language-plaintext highlighter-rouge">multipart/form-data</code> fields:</p>
<table>
    <thead>
        <tr><th>

Name 
</th><th>

Description 
</th></tr>
    </thead>
    <tbody><tr><td>

        <p><code class="language-plaintext highlighter-rouge">ProjectSlug</code></p>
      </td><td>

        <p>The project slug to use.</p>
      </td></tr><tr><td>

        <p><code class="language-plaintext highlighter-rouge">SigningPolicySlug</code></p>
      </td><td>

        <p>The signing policy slug to use.</p>
      </td></tr><tr><td>

        <p><code class="language-plaintext highlighter-rouge">IsFastSigningRequest</code></p>
      </td><td>

        <p>Use <code class="language-plaintext highlighter-rouge">true</code> to get the signature directly in the response. Otherwise you will get only a <code class="language-plaintext highlighter-rouge">SigningRequestId</code> in the response. See also <a href="#signing-request-response">response description</a>.</p>

      </td></tr><tr><td>

        <p><code class="language-plaintext highlighter-rouge">Artifact</code></p>
      </td><td>

        <p>A JSON document containing the the hash to sign and metadata. See <a href="#hash-signing-payload-json">following section</a>.</p>

      </td></tr></tbody>
</table>
<p>Example request:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$FormBoundary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Guid</span><span class="w">

</span><span class="nv">$Response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Invoke-WebRequest</span><span class="w"> </span><span class="nt">-Method</span><span class="w"> </span><span class="nx">Post</span><span class="w"> </span><span class="nt">-Uri</span><span class="w"> </span><span class="s2">"</span><span class="nv">$ApiUrl</span><span class="s2">/v1/</span><span class="nv">$OrganizationId</span><span class="s2">/SigningRequests"</span><span class="w"> </span><span class="se">`
</span><span class="w">    </span><span class="nt">-ContentType</span><span class="w"> </span><span class="s2">"multipart/form-data; boundary=</span><span class="nv">$FormBoundary</span><span class="s2">"</span><span class="w"> </span><span class="se">`
</span><span class="w">    </span><span class="nt">-Headers</span><span class="w"> </span><span class="p">@{</span><span class="w"> </span><span class="nx">Authorization</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Bearer </span><span class="nv">$ApiToken</span><span class="s2">"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="nt">-Body</span><span class="w"> </span><span class="sh">@"
--</span><span class="nv">$FormBoundary</span><span class="sh">
Content-Disposition: form-data; name="ProjectSlug"

</span><span class="nv">$ProjectSlug</span><span class="sh">
--</span><span class="nv">$FormBoundary</span><span class="sh">
Content-Disposition: form-data; name="SigningPolicySlug"

</span><span class="nv">$SigningPolicySlug</span><span class="sh">
--</span><span class="nv">$FormBoundary</span><span class="sh">
Content-Disposition: form-data; name="IsFastSigningRequest"

true
--</span><span class="nv">$FormBoundary</span><span class="sh">
Content-Disposition: form-data; name="Artifact"; filename="payload.json"
Content-Type: application/json

{
    "SignatureAlgorithm": "RsaPkcs1",
    "RsaHashAlgorithm": "2.16.840.1.101.3.4.2.1",
    "Base64EncodedHash": "GJShnIW6FTrL90OsTkP8AEyJFgSyb4xp4eg+oq/HxI8=",

    "Metadata":
    {
        "CreatingProcess": { "CommandLine": "SampleCommand -SampleArgument", "User": "SampleUser" }
    }
}
--</span><span class="nv">$FormBoundary</span><span class="sh">--
"@</span><span class="w">
</span></code></pre></div></div>

<h4 id="hash-signing-payload-json">payload.json format</h4>
<table>
    <thead>
        <tr><th>

JSON property 
</th><th>

Description 
</th></tr>
    </thead>
    <tbody><tr><td>

        <p><code class="language-plaintext highlighter-rouge">SignatureAlgorithm</code></p>
      </td><td>

        <p>For RSA certificates: <code class="language-plaintext highlighter-rouge">"RsaPkcs1"</code> for the PKCS #1 v1.5 padding mode, or <code class="language-plaintext highlighter-rouge">"RsaPss"</code> for PSS padding mode. For elliptic curve certificates: <code class="language-plaintext highlighter-rouge">Ecdsa</code>.</p>

      </td></tr><tr><td>

        <p><code class="language-plaintext highlighter-rouge">RsaHashAlgorithm</code></p>
      </td><td>

        <p>The OID for used hash algorithm with the following allowed values: <code class="language-plaintext highlighter-rouge">"1.2.840.113549.2.5"</code> (MD5), <code class="language-plaintext highlighter-rouge">"1.3.14.3.2.26"</code> (SHA1), <code class="language-plaintext highlighter-rouge">"2.16.840.1.101.3.4.2.1"</code> (SHA-256), <code class="language-plaintext highlighter-rouge">"2.16.840.1.101.3.4.2.2"</code> (SHA-384), <code class="language-plaintext highlighter-rouge">"2.16.840.1.101.3.4.2.3"</code> (SHA-512). <em>Note that this property is only used for RSA certificates.</em></p>

      </td></tr><tr><td>

        <p><code class="language-plaintext highlighter-rouge">Base64EncodedHash</code></p>
      </td><td>

        <p>The Base64 encoded hash value to sign. I.e. the result of the used <code class="language-plaintext highlighter-rouge">RsaHashAlgorithm</code>.</p>

      </td></tr><tr><td>

        <p><code class="language-plaintext highlighter-rouge">Metadata</code></p>
      </td><td>

        <p>Can contain arbitrary metadata JSON values. We recommend to include <code class="language-plaintext highlighter-rouge">CreatingProcess</code> metadata with <code class="language-plaintext highlighter-rouge">CommandLine</code> and <code class="language-plaintext highlighter-rouge">User</code> as shown in the example above.</p>
      </td></tr></tbody>
</table>
<div class="panel info">
  <div class="panel-header">Key length</div>

  <p>The used key length and therefore the length of the resulting <code class="language-plaintext highlighter-rouge">Signature</code> in the response depends on the key length of the used certificate referenced in the signing policy. For ECDSA signatures also the used curve is determined by the certificate.</p>

</div>

<h4 id="signing-request-response">Response</h4>

<p>The response contains a JSON body with the following content depending on the request‚Äôs <code class="language-plaintext highlighter-rouge">IsFastSigningRequest</code> value.</p>

<ul>
  <li>
    <p>If <code class="language-plaintext highlighter-rouge">IsFastSigningRequest</code> was <code class="language-plaintext highlighter-rouge">true</code>: The Base64-encoded signature in the <code class="language-plaintext highlighter-rouge">Signature</code> property and the repeated incoming JSON properties.</p>

    <p>Example response:</p>

    <pre><code class="language-JSON"> {
    "SignatureAlgorithm": "RsaPkcs1",
    "RsaHashAlgorithm": "2.16.840.1.101.3.4.2.1",
    "Base64EncodedHash": "GJShnIW6FTrL90OsTkP8AEyJFgSyb4xp4eg+oq/HxI8=",
    "Metadata": { ... },
    "Signature": "wGI2oiHHVSVGHR1rtjv83Pir1SEVLmnLNGuJD4..."
 }
</code></pre>
  </li>
  <li>
    <p>If <code class="language-plaintext highlighter-rouge">IsFastSigningRequest</code> was <code class="language-plaintext highlighter-rouge">false</code>: Only a <code class="language-plaintext highlighter-rouge">SigningRequestId</code> property. The actual signing operation will be performed asynchronously and can be retrieved via following <code class="language-plaintext highlighter-rouge">GET $ApiUrl/v1/$OrganizationId/</code>‚Äã<code class="language-plaintext highlighter-rouge">SigningRequests/$SigningRequestId</code> requests to check the status and retrieve the signature value.</p>
  </li>
</ul>

<h2 id="retrieve-signing-policy-details">Retrieve Signing Policy details</h2>

<p>Via <code class="language-plaintext highlighter-rouge">GET $ApiUrl/v1/$OrganizationId/</code>‚Äã<code class="language-plaintext highlighter-rouge">Cryptoki/MySigningPolicies</code> all signing policies with the user referenced by the API token assigned as <em>Submitter</em> can be queried. With optional <code class="language-plaintext highlighter-rouge">?projectSlug=$ProjectSlug&amp;</code>‚Äã<code class="language-plaintext highlighter-rouge">signingPolicySlug=$SigningPolicySlug</code> query parameters the returned signing policies can be restricted (to exactly one if the project / signing policy exists).</p>

<p>The response contains signing policy details like the <code class="language-plaintext highlighter-rouge">signingPolicyId</code>, the RSA key parameters or the referenced X.509 certificate (<code class="language-plaintext highlighter-rouge">certificateBytes</code>).</p>

<p>Example response:</p>

<pre><code class="language-JSON">{
    "signingPolicies": [
        {
            "signingPolicySlug": "test-signing",
            "projectSlug": "hash-signing-test",
            "keySizeInBits": 2048,
            "rsaParameters": {
                "publicExponent": "AQAB",
                "modulus": "2e4JTm..."
            },
            "signingPolicyId": "eacd4b78-6038-4450-9eec-4acd1c7ba6f1",
            "certificateBytes": "MIIC5zCC...",
            "keyType": "Rsa",
            "publicKeyBytes": "MIIBCgKC..."
        },
        ... in case multiple signing policies match
    ]
}
</code></pre>

<h1 id="timestamps">Timestamps</h1>

<p>When using SignTool.exe (or any other signing tool) directly, you are responsible for correct time stamping. Here are a few hints:</p>

<ul>
  <li>You may use the timestamp authority (TSA) provided by the certificate authority that issued your code signing certificate or any other CA that provides a free public TSA.</li>
  <li>TSAs may impose quota limits, and free TSAs usually don‚Äôt provide any SLA level.</li>
  <li>TSAs may ignore the parameters you provide, e.g. the hashing algorithm. This may result in invalid timestamps. Depending on the platform, that might only lead to problems after the certificate becomes invalid.</li>
  <li>TSAs may use certificates with a short lifetime. Some platforms, such as Authenticode, accept expired TSA certificates. For other platforms, your signatures might become invalid after the TSA certificate has expired. A good TSA certificate should have a remaining lifetime of about 10 years or more.</li>
</ul>

<p>Always check your signatures and timestamps to ensure that they will be valid after your certificate expires or gets revoked. Otherwise, your signatures may become invalid. Another problem is that revocation for compromised certificates becomes a much harder decision if you cannot rely on timestamps.</p>

<p>If you use the file-based signing method of SignPath, timestamps will be managed automatically.</p>

<h1 id="flow">Signing flow</h1>

<p>This section describes how the various components work together to create a signature.</p>

<p><img src="/assets/img/resources/documentation_crypto_providers-CryptoProvidersSigningFlow.svg" alt="Figure: Signing flow overview" /></p>

<p>With small platform-specific variations, the general flow of a signing operations is as follows:</p>

<ol>
  <li>The <strong>user</strong> invokes the <strong>signing tool</strong>.
    <ul>
      <li>The command line usually specifies a key reference. In SignPath this is the <em>Project</em> and <em>Signing Policy</em>.</li>
      <li>The credentials are passed using the command line or environment variables.</li>
    </ul>
  </li>
  <li>The <strong>signing tool</strong> reads the file and calculates a <strong>hash digest</strong>.
    <ul>
      <li>Depending on the tool, this might be the hash digest of the entire file, or just a of a specific part of the file.</li>
      <li>For Authenticode, this step is performed by a Windows API using a format-specific SIP (Subject Interface Package).</li>
    </ul>
  </li>
  <li>The <strong>signing tool</strong> calls a <strong>System API</strong> (Windows) or an <strong>engine</strong> (PKCS#11) to get a signature block.</li>
  <li>This API or engine calls the <strong>SignPath Crypto Provider</strong>.</li>
  <li>The SignPath Crypto Provider calls the <strong>SignPath REST API</strong> over HTTPS/REST.</li>
  <li><strong>SignPath</strong>
    <ul>
      <li><strong>verifies</strong> the user‚Äôs <strong>credentials and permissions</strong> for the specified <em>Project</em> and <em>Signing Policy</em>,</li>
      <li><strong>selects the key pair or certificate</strong> for this operation,</li>
      <li><strong>uses the HSM to sign</strong> the digest using the specified algorithm,</li>
      <li><em>and</em> writes the entire operation to the audit log.</li>
    </ul>
  </li>
  <li>The resulting <strong>signature block is returned</strong> up the entire call chain.</li>
  <li>The <strong>signing tool writes the signature</strong>
    <ul>
      <li>by inserting it into the signed file,</li>
      <li>by wrapping the file into a signed envelope,</li>
      <li><em>or</em> by creating a <em>detached signature</em> file that must be shipped along the original file.
Again, for Authenticode this is actually performed by the SIP.</li>
    </ul>
  </li>
</ol>

<p>As always, the private key does not leave the boundaries of the HSM.</p>


		</article>
	</div>
</section><!-- last_modified_at:  --><section class='bg-dark-grey font-white newsletter' id="newsletter">
	<div>
		<h2>Sign up for news and special offers</h2>
		<form class="ml-block-form" action="https://app.mailerlite.com/webforms/submit/d7c3i1" data-code="d7c3i1" method="post">
			<input type="text" class="form-control" data-inputmask="" name="fields[name]" value="" placeholder="Name">
			<input type="email" class="form-control" data-inputmask="" name="fields[email]" value="" placeholder="Email">
			<input type="hidden" name="ml-submit" value="1">
			<button type="submit" class="btn btn-secondary newsletter">Subscribe</button>
		</form>
	</div>
</section>
</main>
  <footer>
  	<div>
	  	<div>
	  		<img src='/assets/signpath-logo-white.svg' width="334" height="67" alt='SignPath'/>
	  		<svg viewBox="0 0 244 18">
			  <text x="0" y="15">CODE SIGNING SIMPLE &amp; SECURE</text>
			</svg>
	  		<div>
				<a target="_blank" href="https://www.linkedin.com/company/33243108" rel="noopener noreferrer">
<svg class="icon footer" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path fill="currentColor"  d="M 8.6425781 4 C 7.1835781 4 6 5.181625 6 6.640625 C 6 8.099625 7.182625 9.3085938 8.640625 9.3085938 C 10.098625 9.3085938 11.283203 8.099625 11.283203 6.640625 C 11.283203 5.182625 10.101578 4 8.6425781 4 z M 21.535156 11 C 19.316156 11 18.0465 12.160453 17.4375 13.314453 L 17.373047 13.314453 L 17.373047 11.310547 L 13 11.310547 L 13 26 L 17.556641 26 L 17.556641 18.728516 C 17.556641 16.812516 17.701266 14.960938 20.072266 14.960938 C 22.409266 14.960937 22.443359 17.145609 22.443359 18.849609 L 22.443359 26 L 26.994141 26 L 27 26 L 27 17.931641 C 27 13.983641 26.151156 11 21.535156 11 z M 6.3632812 11.310547 L 6.3632812 26 L 10.923828 26 L 10.923828 11.310547 L 6.3632812 11.310547 z"/></svg></a>
				&nbsp;&nbsp;
				<a target="_blank" href="mailto:info@signpath.io" rel="noopener noreferrer"><svg class="icon footer" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path fill="currentColor" d="M 3 8 L 3 26 L 29 26 L 29 8 Z M 7.3125 10 L 24.6875 10 L 16 15.78125 Z M 5 10.875 L 15.4375 17.84375 L 16 18.1875 L 16.5625 17.84375 L 27 10.875 L 27 24 L 5 24 Z"/></svg>
</div>
	  	</div>
	  	<div>
	  		<a href='/privacy-policy'>Privacy Policy</a>
	  		<a href='/terms-of-service'>Terms of Service</a>
	  		<a href='/status'><span style="color: lightgreen;"><svg class="icon small" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path fill="currentColor" d="M 28.28125 6.28125 L 11 23.5625 L 3.71875 16.28125 L 2.28125 17.71875 L 10.28125 25.71875 L 11 26.40625 L 11.71875 25.71875 L 29.71875 7.71875 Z"/></svg>
</span>Status
			</a>
	  	</div>
	</div>
  </footer>
        <div id='cookie-info'>
            <h3>Cookie settings</h3>
            <div class="container">
                <span>We use cookies to enhance your browsing experience.</span>
                <p class="mobile show-more active"><a>Show more information</a></p>
                <p class="mobile show-less"><a>Show less information</a></p>
                <span class="information">By clicking the ‚ÄúAccept‚Äù button below, you agree that non-essential cookies on our website may be used by us and by third parties, some of them located in the USA. Learn more about our cookies in our <a
                            href='/privacy-policy'>Privacy
					Policy</a>
                </span>
				<div class="actions">
					<button class='btn btn-primary' id='acknowledge-cookies-btn'>Accept</button>
					<button class="btn btn-grey" id='refuse-cookies-btn'>Refuse</button>
				</div>
            </div>
			<script>
				const queryString = window.location.search;
				const urlParams = new URLSearchParams(queryString);
				const adgroupid = urlParams.get('adgroupid') ? urlParams.get('adgroupid') : document.cookie.match('(^|;)\\s*' + 'adgroupid' + '\\s*=\\s*([^;]+)')?.pop() || ''

				if (adgroupid) {
					const els_trial = document.querySelectorAll("a[href='" + window.location.protocol + '//' + window.location.hostname + '/Web/Subscription/StartFreeTrial' + "']")
					const els_login = document.querySelectorAll("a[href='" + window.location.protocol + '//' + window.location.hostname + '/Web/Home/Login' + "']");

					for (let child of els_trial) {
						if (child.tagName === 'A') {
							child.href = child.href + '?websiteCorrelationId=' + adgroupid
						}
					}

					for (let child of els_login) {
						if (child.tagName === 'A') {
							child.href = child.href + '?websiteCorrelationId=' + adgroupid
						}
					}
				}
			</script>
		</div>
	</footer>
</body>
</html>
